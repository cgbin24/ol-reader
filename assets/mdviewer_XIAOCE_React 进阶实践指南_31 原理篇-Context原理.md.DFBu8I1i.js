import{_ as s}from"./app.BdTF1atn.js";import{j as i,i as e,Z as n}from"./chunks/@vue.D6nrJjhM.js";/* empty css                          */import"./chunks/@vueuse.ErXst1iV.js";const C=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"mdviewer/XIAOCE/React è¿›é˜¶å®è·µæŒ‡å—/31 åŸç†ç¯‡-ContextåŸç†.md","filePath":"mdviewer/XIAOCE/React è¿›é˜¶å®è·µæŒ‡å—/31 åŸç†ç¯‡-ContextåŸç†.md"}'),a={name:"mdviewer/XIAOCE/React è¿›é˜¶å®è·µæŒ‡å—/31 åŸç†ç¯‡-ContextåŸç†.md"},t=n(`<h2 id="è¿‡æ—¶çš„-react-api" tabindex="-1">è¿‡æ—¶çš„ React API â€‹</h2><p>æ¥ä¸‹æ¥å°†ä»‹ç» <code>context</code> åŸç†ã€‚é‡ç‚¹æµç¨‹æ”¾åœ¨ context çš„<strong>ä¼ é€’å’Œæ›´æ–°</strong>ä¸¤ä¸ªæ–¹é¢ã€‚å¯¹äºåŸç†éƒ¨åˆ†ï¼Œæˆ‘åœ¨è¿™é‡Œåªä»‹ç»äº†æ–°ç‰ˆæœ¬ Context çš„åŸç†ã€‚æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸€ä¸‹æºç ã€‚</p><p>ä»¥ <code>React 16.8</code> ä¸ºä¾‹å­ğŸŒ°ï¼š</p><ul><li>æ–°ç‰ˆæœ¬ Context ä½ç½®ï¼š<code>react-reconciler/src/ReactFiberNewContext.js</code></li><li>è€ç‰ˆæœ¬ Context ä½ç½®ï¼š<code>react-reconciler/src/ReactFiberContext.js</code></li></ul><p>å¸Œæœ›å¤§å®¶å¸¦ç€è¿™äº›é—®é¢˜å»é˜…è¯»</p><ul><li>1 Provder å¦‚ä½•ä¼ é€’ contextï¼Ÿ</li><li>2 ä¸‰ç§è·å– context åŸç† ï¼ˆ <code>Consumer</code>ï¼Œ <code>useContext</code>ï¼Œ<code>contextType</code> ï¼‰ï¼Ÿ</li><li>3 æ¶ˆè´¹ <code>context</code> çš„ç»„ä»¶ï¼Œcontext æ”¹å˜ï¼Œä¸ºä»€ä¹ˆä¼šè®¢é˜…æ›´æ–° ï¼ˆå¦‚ä½•å®ç°ï¼‰ ã€‚</li><li>4 context æ›´æ–°ï¼Œå¦‚ä½•é¿å… <code>pureComponent</code> ï¼Œ <code>shouldComponentUpdate</code> æ¸²æŸ“æ§åˆ¶ç­–ç•¥çš„å½±å“ã€‚</li><li>5 å¦‚ä½•å®ç°çš„ context åµŒå¥—ä¼ é€’ ï¼ˆ å¤šä¸ª Povider ï¼‰?</li></ul><h3 id="_1-context-å¯¹è±¡" tabindex="-1">1 context å¯¹è±¡ â€‹</h3><p>ä¸Šè¿°æ‰€è¯´çš„è€ç‰ˆæœ¬ context å°±æ˜¯ Legacy Context æ¨¡å¼ä¸‹çš„ context ï¼Œè€ç‰ˆæœ¬çš„ context æ˜¯é‡‡ç”¨çº¦å®šå¼çš„ä½¿ç”¨è§„åˆ™ï¼Œäºæ˜¯æœ‰äº† <code>getChildContext</code> å’Œ <code>childContextTypes</code> åå•†çš„å±æ€§å’Œæ–¹æ³•ï¼Œè¿™ç§æ–¹å¼ä¸ä»…ä¸å¤Ÿçµæ´»ï¼Œè€Œä¸”å¯¹äºå‡½æ•°ç»„ä»¶ä¹Ÿå­˜åœ¨å±€é™æ€§ï¼Œæ‰€ä»¥åœ¨ <code>v16.3</code> æ¨å‡ºäº†æ–°ç‰ˆæœ¬çš„ contextï¼Œå¼€å‘è€…èƒ½å¤Ÿæ›´åŠ çµæ´»çš„è¿ç”¨ <code>Context</code>ã€‚æ–°ç‰ˆæœ¬å¼•å…¥ context å¯¹è±¡çš„æ¦‚å¿µï¼Œè€Œä¸” context å¯¹è±¡ä¸Šé™¤äº†ä¿ç•™äº†ä¼ é€’çš„ä¿¡æ¯ <code>value</code> å¤– ï¼Œ è¿˜æœ‰æä¾›è€… <code>Provder</code> å’Œæ¶ˆè´¹è€… <code>Consumer</code>ã€‚</p><h4 id="context-å¯¹è±¡" tabindex="-1">context å¯¹è±¡ â€‹</h4><p>è¦æƒ³åƒé€ context ï¼Œé¦–å…ˆè¦ç ”ç©¶ä¸€ä¸‹ Context å¯¹è±¡æ˜¯ä»€ä¹ˆã€‚ä¸Šè¿°è®²åˆ°å¯ä»¥é€šè¿‡ <code>createContext</code> åˆ›å»ºä¸€ä¸ª context ã€‚é‚£ä¹ˆä¸‡ç‰©ä¹‹æºå°±æ˜¯è¿™ä¸ª API ï¼Œæ¥ä¸‹æ¥ä¸€èµ·æ­å¼€ context å¯¹è±¡é¢çº±ã€‚</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">defaultValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">calculateChangedBits</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">){</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   /* context å¯¹è±¡æœ¬è´¨  */</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> context</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $$typeof: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">REACT_CONTEXT_TYPE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* æœ¬è´¨ä¸Šå°±æ˜¯ Consumer element ç±»å‹ */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        _calculateChangedBits: calculateChangedBits,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        _currentValue: defaultValue,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        _threadCount: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Provider: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Consumer: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* æœ¬è´¨ä¸Šå°±æ˜¯ Provider element ç±»å‹ã€‚  */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  context.Provider </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    $$typeof: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">REACT_PROVIDER_TYPE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    _context: context,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  context.Consumer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>å¦‚ä¸Šå¯ä»¥å¾ˆå®¹æ˜“çš„çœ‹æ¸…æ¥š context å¯¹è±¡çš„æœ¬è´¨ï¼Œè¿™é‡Œé‡ç‚¹ä»‹ç»ä¸‰ä¸ªå±æ€§</p><ul><li><code>Provider</code> æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª element å¯¹è±¡ $$typeof -&gt; <code>REACT_PROVIDER_TYPE</code></li><li><code>Consumer</code> æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ª element å¯¹è±¡ $$typeof -&gt; <code>REACT_CONTEXT_TYPE</code></li><li><code>_currentValue</code> è¿™ä¸ªç”¨æ¥ä¿å­˜ä¼ é€’ç»™ Provider çš„ value ã€‚</li></ul><h4 id="provider-æä¾›è€…" tabindex="-1">Provider æä¾›è€… â€‹</h4><p>ä¸Šè¿°æ˜ç™½äº† Provider æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ React Element å¯¹è±¡ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥é‡ç‚¹çœ‹ä¸€ä¸‹ Provider çš„å®ç°åŸç†ï¼Œç ”ç©¶ Provider é‡ç‚¹å›´ç»•è¿™ä¸¤ä¸ªç‚¹ã€‚</p><ul><li>Provider å¦‚ä½•ä¼ é€’ context çŠ¶æ€çš„ã€‚</li><li>Provider ä¸­ value æ”¹å˜ï¼Œå¦‚ä½•é€šçŸ¥è®¢é˜… contextã€‚</li></ul><p>ä¹‹å‰çš„ç« èŠ‚è®²è¿°äº† <strong>jsx -&gt; element -&gt; fiber</strong> çš„æµç¨‹ï¼ŒæŒ‰ç…§è¿™ä¸ªé€»è¾‘ï¼Œæ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ Provdier çš„å¤„ç†ã€‚</p><ul><li>é¦–å…ˆæ ‡ç­¾å½¢å¼çš„ <code>&lt;Provider&gt;</code> æœ¬è´¨ä¸Šå°±æ˜¯ <code>REACT_PROVIDER_TYPE</code> çš„ React Element ã€‚<code>&lt;Provider&gt;</code> -&gt; <code>REACT_PROVIDER_TYPE</code> React element ã€‚</li><li>æ¥ä¸‹æ¥ element ä¼šè½¬åŒ–æˆ fiber ï¼Œfiber ç±»å‹ä¸º <strong>ContextProvider</strong> ï¼Œ React element -&gt; <code>ContextProvide fiber</code>ã€‚</li></ul><p>ContextProvider ç±»å‹çš„ fiber ï¼Œåœ¨ fiber è°ƒå’Œé˜¶æ®µä¼šè¿›å…¥åˆ° <code>beginWork</code> æµç¨‹ï¼Œè¿™ä¸ªé˜¶æ®µä¼šå‘ç”Ÿä¸¤ä»¶äº‹ã€‚</p><ul><li>å¦‚æœå½“å‰ç±»å‹çš„ fiber ä¸éœ€è¦æ›´æ–°ï¼Œé‚£ä¹ˆä¼š <code>FinishedWork</code> ä¸­æ­¢å½“å‰èŠ‚ç‚¹å’Œå­èŠ‚ç‚¹çš„æ›´æ–°ã€‚</li><li>å¦‚æœå½“å‰ç±»å‹ fiber éœ€è¦æ›´æ–°ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨ä¸åŒç±»å‹ fiber çš„å¤„ç†æ–¹æ³•ã€‚å½“ç„¶ <code>ContextProvider</code> ä¹Ÿæœ‰ç‰¹æœ‰çš„ fiber æ›´æ–°æ–¹æ³• â€”â€” <code>updateContextProvider</code>ï¼Œé‚£ä¹ˆå¦‚æœæƒ³è¦æ·±å…¥ <code>Provder</code> çš„å¥¥ç§˜ï¼Œæœ‰å¿…è¦çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•åšäº†äº›ä»€ä¹ˆï¼Ÿ</li></ul><blockquote><p>react-reconciler/src/ReactFiberBeginWork.js</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> updateContextProvider</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">current</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">workInProgress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">renderExpirationTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /*  è·å– Provder ä¸Šçš„ value  */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  pushProvider</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(workInProgress, newProps.value;);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* æ›´æ–° context  */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (oldProps </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> changedBits</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> calculateChangedBits</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(context, newProps.value;, oldProps.value);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (changedBits </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      //context æ²¡æœ‰å˜åŒ–ã€‚å¦‚æœå­©å­ä»¬éƒ½æ˜¯ä¸€æ ·çš„è¯ã€‚é‚£ä¹ˆä¸éœ€è¦æ›´æ–°</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        oldProps.children </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> newProps.children </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        !</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">hasLegacyContextChanged</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ...</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // åœæ­¢è°ƒåˆå­èŠ‚ç‚¹,æ”¶å°¾å·¥ä½œ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* context æ”¹å˜ï¼Œæ›´æ–° context */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      propagateContextChange</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">( workInProgress,context, changedBits, renderExpirationTime,);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* ç»§ç»­å‘ä¸‹è°ƒå’Œå­ä»£ fiber  */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>å¦‚ä¸Šä¿ç•™äº† <code>updateContextProvider</code> çš„æ ¸å¿ƒæµç¨‹å¦‚ä¸‹ï¼š</p><ul><li><p>ç¬¬ä¸€æ­¥ï¼š é¦–å…ˆä¼šè°ƒç”¨ <code>pushProvider</code>ï¼Œ<code>pushProvider</code> ä¼šè·å– type å±æ€§ä¸Šçš„ _context å¯¹è±¡ï¼Œå°±æ˜¯ä¸Šè¿°é€šè¿‡ <code>createContext</code> åˆ›å»ºçš„ context å¯¹è±¡ã€‚ç„¶åå°† Provider çš„ value å±æ€§ï¼Œèµ‹å€¼ç»™ context çš„ _currentValue å±æ€§ä¸Šã€‚<strong>è¿™é‡Œè§£é‡Šäº† Provder é€šè¿‡ä»€ä¹ˆæ‰‹æ®µä¼ é€’ context valueï¼Œå³é€šè¿‡æŒ‚è½½ context çš„ _currentValue å±æ€§</strong>ã€‚</p></li><li><p>ç¬¬äºŒæ­¥ï¼š é€šè¿‡ <code>calculateChangedBits</code> è®¡ç®—å‡º changedBits ï¼Œ<code>calculateChangedBits</code> å†…éƒ¨è§¦å‘ context å¯¹è±¡ä¸Šçš„ <code>_calculateChangedBits</code> ï¼Œç»†å¿ƒçš„åŒå­¦å¯ä»¥å‘ç°ï¼Œåœ¨è°ƒç”¨ <code>createContext</code> çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ˜¯æœ‰ç¬¬äºŒä¸ªå‚æ•°çš„ <code>calculateChangedBits</code>ï¼Œåœ¨æ›´æ–° Provider çš„æ—¶å€™è¿™ä¸ªå‚æ•°å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œå½“å®ƒè¿”å›çš„ <code>changedBits === 0</code> çš„æ—¶å€™ï¼Œé‚£ä¹ˆè¿˜ä¼šæµ…æ¯”è¾ƒ children æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œè¿˜æœ‰å°±æ˜¯æœ‰æ²¡æœ‰ <code>legacy context</code>ï¼Œå¦‚æœè¿™ä¸‰ç‚¹éƒ½æ»¡è¶³çš„è¯ï¼Œé‚£ä¹ˆä¼šåˆ¤æ–­å½“å‰ Provider å’Œå­èŠ‚ç‚¹ä¸éœ€è¦æ›´æ–°ï¼Œé‚£ä¹ˆä¼š return åœæ­¢å‘ä¸‹è°ƒå’Œå­èŠ‚ç‚¹ã€‚</p></li><li><p>ç¬¬ä¸‰æ­¥ï¼ˆ<strong>é‡ç‚¹</strong>ï¼‰ï¼šåœ¨å®é™…å¼€å‘ä¸­ï¼Œç»å¤§å¤šæ•°å½“ value å‘ç”Ÿå˜åŒ–ï¼Œä¼šèµ° <code>propagateContextChange</code> è¿™ä¸ªæµç¨‹ï¼Œä¹Ÿæ˜¯ Provider æ›´æ–°çš„ç‰¹ç‚¹ã€‚é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•åˆ°åº•åšäº†äº›ä»€ä¹ˆå‘¢ï¼Ÿæ¥ä¸‹æ¥é‡ç‚¹çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°åšäº†äº›ä»€ä¹ˆï¼Ÿ</p></li></ul><p><strong>propagateContextChange</strong> å‡½æ•°æµç¨‹å¾ˆç¹çï¼Œè¿™é‡Œç®€åŒ–äº†æµç¨‹ï¼Œä¿ç•™äº†æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ã€‚</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> propagateContextChange</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">workInProgress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fiber </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> workInProgress.child;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (fiber </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        fiber.return </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> workInProgress;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fiber </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> list</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fiber.dependencies;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">         while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (dependency </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">              if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (dependency.context </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context){</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                   /* ç±»ç»„ä»¶ï¼šä¸å— PureComponent å’Œ shouldComponentUpdate å½±å“ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (fiber.tag </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ClassComponent) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                         /* ä¼šèµ° forceUpdate é€»è¾‘ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> update</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createUpdate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(renderExpirationTime, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                        update.tag </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ForceUpdate;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                        enqueueUpdate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fiber, update);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                   }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                   /* é‡è¦ï¼šTODO: æé«˜ fiber çš„ä¼˜å…ˆçº§ï¼Œè®©å½“å‰ fiber å¯ä»¥ beginWork ï¼Œå¹¶ä¸”å‘ä¸Šæ›´æ–°çˆ¶çº§ fiber é“¾ä¸Šçš„ä¼˜å…ˆçº§ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                   ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">              } </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><code>propagateContextChange</code> éå¸¸é‡è¦ï¼Œå®ƒçš„èŒè´£å°±æ˜¯æ·±åº¦éå†æ‰€æœ‰çš„å­ä»£ fiber ï¼Œç„¶åæ‰¾åˆ°é‡Œé¢å…·æœ‰ <code>dependencies</code> çš„å±æ€§ï¼Œå¯¹æ¯” dependencies ä¸­çš„ context å’Œå½“å‰ Provider çš„ context æ˜¯å¦æ˜¯åŒä¸€ä¸ªï¼Œå¦‚æœæ˜¯åŒä¸€ä¸ªï¼Œé‚£ä¹ˆå¦‚æœå½“å‰ fiber æ˜¯ç±»ç»„ä»¶ï¼Œé‚£ä¹ˆä¼šç»™ç»‘å®šä¸€ä¸ª forceUpdate æ ‡è¯† ã€‚ç„¶åä¼šæé«˜ fiber çš„æ›´æ–°ä¼˜å…ˆçº§ï¼Œè®© fiber åœ¨æ¥ä¸‹æ¥çš„è°ƒå’Œè¿‡ç¨‹ä¸­ï¼Œå¤„äºä¸€ä¸ªé«˜ä¼˜å…ˆçº§å¾…æ›´æ–°çš„çŠ¶æ€ã€‚æ¥ä¸‹æ¥çš„ä»£ç æ¯”è¾ƒé•¿ï¼Œæˆ‘è¿™é‡Œæ²¡æœ‰å…¨éƒ¨ç½—åˆ—å‡ºæ¥ï¼Œå¤§è‡´é€»è¾‘å°±æ˜¯ï¼Œæ‰¾åˆ°å½“å‰ fiber å‘ä¸Šçš„çˆ¶çº§é“¾ä¸Šçš„ fiber ï¼Œç»Ÿä¸€æ›´æ–°ä»–ä»¬çš„ä¼˜å…ˆçº§ï¼Œä½¿ä¹‹å˜æˆé«˜ä¼˜å…ˆçº§å¾…æ›´æ–°çŠ¶æ€ã€‚</p><p>é‚£ä¹ˆä¸Šè¿°æµç¨‹ä¸­æš´éœ²å‡ºå‡ ä¸ªé—®é¢˜ï¼š</p><ul><li><p>1 ä»€ä¹ˆæƒ…å†µä¸‹ fiber ä¼šå­˜åœ¨ dependencies ï¼Œé¦–å…ˆ dependencies åœ¨ç¬¬åä¸ƒç« ä¸­ä¼šè®²åˆ°ï¼Œå®ƒä¿å­˜çš„æ˜¯ context çš„ä¾èµ–é¡¹ï¼Œé‚£ä¹ˆä»€ä¹ˆæƒ…å†µä¸‹ä¼šå­˜åœ¨ <strong>context ä¾èµ–é¡¹</strong>ã€‚</p></li><li><p>2 ä¸ºä»€ä¹ˆå¯¹äº class ç±»ç»„ä»¶ä¼šåˆ›å»ºä¸€ä¸ª ForceUpdate ç±»å‹çš„ update å¯¹è±¡å‘¢ï¼Ÿ çŸ¥å…¶ç„¶ï¼ŒçŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹å®ƒæ˜¯ä»€ä¹ˆï¼Ÿ</p></li></ul><p><strong>ï½œ--------é—®ä¸ç­”--------ï½œ</strong></p><p>é—®ï¼š <strong>ForceUpdate ç±»å‹ update</strong>ï¼š ä»€ä¹ˆæ˜¯ forceUpdate ç±»å‹çš„ update å‘¢ï¼Ÿ</p><p>ç­”ï¼šåœ¨ç±»ç»„ä»¶ä¸­ï¼Œé€šè¿‡è°ƒç”¨ <code>this.forceUpdate()</code> å¸¦æ¥çš„æ›´æ–°å°±ä¼šè¢«æ‰“ä¸Š ForceUpdate ç±»å‹çš„ update tagï¼Œè¿™é‡Œå¯ä»¥ç†è§£ä¸ºå¼ºåˆ¶æ›´æ–°ã€‚ ç”Ÿå‘½å‘¨æœŸç« èŠ‚è®²è¿‡ï¼Œ åœ¨ç±»ç»„ä»¶æ›´æ–°æµç¨‹ä¸­ï¼Œå¼ºåˆ¶æ›´æ–°ä¼šè·³è¿‡ <code>PureComponent</code> å’Œ <code>shouldComponentUpdate</code> ç­‰ä¼˜åŒ–ç­–ç•¥ã€‚</p><p><strong>ï½œ---------end---------ï½œ</strong></p><ul><li>3 å­˜åœ¨ dependency çš„ fiber ï¼Œä¸ºä»€ä¹ˆè¦å‘ä¸Šæ›´æ–°çˆ¶çº§ fiber é“¾ä¸Šçš„ä¼˜å…ˆçº§ï¼Œè®©æ‰€æœ‰çˆ¶çº§ fiber éƒ½å¤„äºä¸€ä¸ªé«˜ä¼˜å…ˆçº§ã€‚</li></ul><p>å¯¹äºä¸Šé¢è¿™ä¸‰ä¸ªé—®é¢˜ï¼Œè·Ÿä¸Šæˆ‘çš„æ€è·¯é€ä¸€çªç ´ã€‚</p><p><strong>ç¬¬ä¸€ä¸ªé—®é¢˜</strong>ï¼š é¦–å…ˆå°±æ˜¯ dependencies å±æ€§ï¼Œè¿™ä¸ªå±æ€§å¯ä»¥æŠŠå½“å‰çš„ fiber å’Œ context å»ºç«‹èµ·å…³è”ï¼Œé‚£ä¹ˆå¯ä»¥ç†è§£æˆï¼Œä½¿ç”¨äº†å½“å‰ context çš„ fiber ä¼šæŠŠ context æ”¾åœ¨ dependencies ä¸­ï¼Œdependencies å±æ€§æœ¬èº«æ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„ï¼Œä¸€ä¸ª fiber å¯ä»¥æœ‰å¤šä¸ª context ä¸ä¹‹å¯¹åº”ã€‚åè¿‡æ¥æ¨æµ‹ä¸€ä¸‹ï¼Œä»€ä¹ˆæƒ…å†µä¸‹ä¼šä½¿ç”¨ context å‘¢ã€‚é‚£ä¹ˆæœ‰ä»¥ä¸‹å‡ ç§å¯èƒ½ï¼š</p><ul><li>1 æœ‰ <code>contextType</code> é™æ€å±æ€§æŒ‡å‘çš„ç±»ç»„ä»¶ã€‚</li><li>2 ä½¿ç”¨ <code>useContext</code> hooks çš„å‡½æ•°ç»„ä»¶ã€‚</li><li>3 context æä¾›çš„ <code>Consumer</code>ã€‚</li></ul><p>é‚£ä¹ˆå¯ä»¥å¤§èƒ†çš„æ¨æµ‹ä¸€ä¸‹ï¼Œ<strong>ä½¿ç”¨è¿‡ contextType useContext çš„ç»„ä»¶å¯¹åº” fiber,å’Œ Consumer ç±»å‹ fiberï¼Œä¼šå’Œ dependencies å»ºç«‹èµ·è”ç³»ï¼Œä¼šæŠŠå½“å‰æ¶ˆè´¹çš„ context æ”¾å…¥ dependencies ä¸­ã€‚è¿™ä¸ªä¸‹é¢ä¼šç»™è¯¦ç»†è§£é‡Š</strong></p><p><strong>ç¬¬äºŒä¸ªé—®é¢˜</strong>ï¼š ä¸ºä»€ä¹ˆå¯¹äº class ç»„ä»¶ä¼šåˆ›å»ºä¸€ä¸ª ForceUpdate çš„ update å‘¢ï¼Ÿ</p><p>åœ¨<strong>ç”Ÿå‘½å‘¨æœŸç« èŠ‚å’Œæ¸²æŸ“æ§åˆ¶ç« èŠ‚</strong>ï¼Œè®²åˆ°è¿‡å¦‚æœæƒ³è¦è®©ç±»ç»„ä»¶è°ƒç”¨ renderï¼Œå¾—åˆ°æ–°çš„ childrenï¼Œé‚£ä¹ˆå°±è¦é€šè¿‡ <code>PureComponent</code> å’Œ <code>shouldComponentUpdate</code> ç­‰å±‚å±‚é˜»ç¢ï¼Œé‚£ä¹ˆ context è¦çªç ´è¿™äº›æ§åˆ¶ï¼Œå°±è¦åšåˆ°å½“ value æ”¹å˜ï¼Œæ¶ˆè´¹ context çš„ç±»ç»„ä»¶æ›´æ–°ï¼Œåˆ™éœ€è¦é€šè¿‡ forceUpdate å¼ºåˆ¶æ›´æ–°ã€‚è¿™æ ·å°±è§£å†³äº†ç±»ç»„ä»¶æ›´æ–°é™åˆ¶ã€‚</p><p>é‚£ä¹ˆæ€»ç»“ä¸€ä¸‹æµç¨‹ï¼Œå½“ Provider çš„ value æ›´æ–°ä¹‹åï¼ŒProvider ä¸‹é¢çš„åªè¦æœ‰æ¶ˆè´¹äº† context çš„ç±»ç»„ä»¶ï¼Œå°±ä¼šè§¦å‘å¼ºåˆ¶æ›´æ–°ã€‚è¿™ä¹Ÿå°±è§£é‡Šäº†æœ€å¼€å§‹çš„é—®é¢˜â€”â€”<strong>context æ›´æ–°ï¼Œå¦‚ä½•é¿å… <code>pureComponent</code> ï¼Œ <code>shouldComponentUpdate</code> æ¸²æŸ“æ§åˆ¶ç­–ç•¥çš„å½±å“</strong>ã€‚ ç”¨ä¸€å¹…æµç¨‹å›¾è¡¨ç¤ºï¼š</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6ad02d5d2b0640ca8d376abebff714a2~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="context7.jpg"></p><p><strong>ç¬¬ä¸‰ä¸ªé—®é¢˜</strong>ï¼š è¿™ä¸ªé—®é¢˜å°±è¦ä» Provider ç±»å‹çš„ fiber è°ƒå’Œå¼€å§‹è®²ã€‚</p><h4 id="provider-å’Œ-beiginwork-è°ƒå’Œæ›´æ–°æœºåˆ¶" tabindex="-1">Provider å’Œ beiginWork è°ƒå’Œæ›´æ–°æœºåˆ¶ â€‹</h4><p>æ¥ä¸‹æ¥é‡ç‚¹ä»‹ç» Provider å’Œ beiginWork è°ƒå’Œæ›´æ–°æœºåˆ¶ã€‚é¦–å…ˆå¼•å‡ºä¸¤ä¸ªæ€è€ƒç‚¹ï¼š</p><ul><li>ç¬¬ä¸€ä¸ªç±»ç»„ä»¶æ‰§è¡Œ render ï¼Œå‡½æ•°ç»„ä»¶æ‰§è¡Œå°±æ˜¯æ¸²æŸ“ä¹ˆï¼Ÿ</li><li>ç¬¬äºŒä¸ª Context æ”¹å˜å¦‚ä½•åšåˆ°æ¶ˆè´¹ context çš„ç»„ä»¶æ›´æ–°çš„ï¼Ÿï¼ˆæ›´æ–°åŸç†ï¼‰</li></ul><p>å…ˆæ¥çœ‹ä¸€ä¸‹ç¬¬ä¸€ä¸ªæ€è€ƒç‚¹ï¼Œå…³äºæ¸²æŸ“çš„æ€è€ƒï¼Œå®é™…ä¸Šåœ¨ React æ•´ä¸ª <code>Reconciler</code> è°ƒå’Œæµç¨‹ä¸­ï¼Œä»æ›´æ–°è°ƒåº¦ä»»åŠ¡çš„å‘èµ·ï¼Œå†åˆ°åœ¨ commit å’Œ render ä¸¤å¤§é˜¶æ®µï¼Œå†åˆ°çœŸå®çš„ dom å…ƒç´ ç»˜åˆ¶ï¼Œæ¯ä¸€ä¸ªç¯èŠ‚éƒ½å±äºæ¸²æŸ“çš„ä¸€éƒ¨åˆ†ã€‚è€Œå¼€å‘è€…èƒ½å¤Ÿæ§åˆ¶çš„ render ï¼Œåªæ˜¯å…¶ä¸­çš„ä¸€å°éƒ¨åˆ†â€”â€”ç±»ç»„ä»¶æ‰§è¡Œ render ï¼Œå‡½æ•°ç»„ä»¶æ‰§è¡Œã€‚è€Œä¸”è¿™äº›æœ¬è´¨ä¸Šéƒ½å‘ç”Ÿåœ¨ FunctionComponent fiber å’Œ ClassComponent fiber ä¸Šã€‚ä½†æ˜¯æ•´ä¸ª fiber æ ‘åœ¨è°ƒå’Œé˜¶æ®µéƒ½éœ€è¦æ›´æ–°çš„ã€‚æ›´æ–°è°ƒå’Œ fiber çš„æ–¹æ³•åœ¨ React åº•å±‚å«åš <code>beginWork</code>ã€‚æœ‰ä¸€ä¸ªé—®é¢˜éœ€è¦æ³¨æ„ï¼Œå°±æ˜¯ <code>beginWork</code> é renderã€‚å…ˆæ¥çœ‹çœ‹ä¸¤è€…çš„åŒºåˆ«ã€‚</p><ul><li><code>beginWork</code> ï¼š åœ¨ä¸€æ¬¡æ›´æ–°ä¸­ï¼Œåªè¦éœ€è¦æ›´æ–°çš„ fiber æˆ–è€…å—åˆ°ç‰µè¿çš„ fiberï¼Œéƒ½ä¼šæ‰§è¡Œ beginWork ã€‚</li><li><code>render</code> ï¼š åœ¨ä¸€æ¬¡æ›´æ–°ä¸­ï¼Œåªæœ‰ç»„ä»¶ç±»å‹çš„ fiber ä¼šæ‰§è¡Œ render ï¼Œå¾—åˆ°æ–°çš„ children ã€‚å¦‚æœç»„ä»¶è§¦å‘ render é‚£ä¹ˆå®ƒä¸€å®šç»å†è¿‡ <code>beginWork</code></li></ul><p>è¿™é‡Œå¦‚æœæœ‰åŒå­¦ä¸æ˜ç™½ä¸è¦ç´§ï¼Œæ¥ç€å¾€ä¸‹çœ‹ã€‚</p><p>æ¯”å¦‚å‘ç”Ÿä¸€æ¬¡æ›´æ–°ä»»åŠ¡ï¼Œæ­¤æ¬¡æ›´æ–°å¯èƒ½å‘ç”Ÿæ•´ä¸ª fiber æ ‘çš„ä»»æ„æå¶ä¸Šï¼Œä½†æ˜¯å› ä¸º context props ç©¿é€å½±å“ï¼ŒReact ä¸çŸ¥é“æ­¤æ¬¡æ›´æ–°çš„æ³¢åŠèŒƒå›´ï¼Œé‚£ä¹ˆå¦‚ä½•å¤„ç†å‘¢ï¼Ÿ React ä¼šä» rootFiber å¼€å§‹æ›´æ–°ï¼Œæ¯ä¸€ä¸ªæ›´æ–° fiber éƒ½ä¼šèµ° <code>beginWork</code> æµç¨‹ï¼Œå¼€å§‹æ‰¾ä¸åŒï¼Œæ‰¾åˆ°æœ‰æ²¡æœ‰éœ€è¦æ›´æ–°çš„åœ°æ–¹ï¼Œé‚£ä¹ˆæŒ‡æ ‡æ˜¯ä»€ä¹ˆå‘¢ï¼Œå…¶ä¸­ä¸€ä¸ªé‡è¦çš„æŒ‡æ ‡å°±æ˜¯<strong>æ›´æ–°çš„ä¼˜å…ˆçº§</strong>ï¼Œè€ç‰ˆæœ¬ç”¨çš„æ˜¯ <code>expirationTime</code> ï¼Œæ–°ç‰ˆæœ¬ç”¨çš„æ˜¯ <code>lane</code>ï¼Œé‚£ä¹ˆå°±è¦ä¿è¯ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚æœæ›´æ–°å‘ç”Ÿåœ¨ä¸€ä¸ªå­ä»£èŠ‚ç‚¹ï¼Œé‚£ä¹ˆåªæœ‰çˆ¶èŠ‚ç‚¹ <code>beginWork</code> æ‰èƒ½è®©å­ä»£èŠ‚ç‚¹ <code>beginWork</code>ã€‚è¿™æ ·å°±å½¢æˆäº†ä¸€æ¡ root fiber -&gt; çˆ¶ fiber -&gt; å­ fiber çš„ <code>beginWork</code> é“¾ã€‚åœ¨ beginwork è¿‡ç¨‹ä¸­ï¼Œæœ‰å‡ ç§æƒ…å†µï¼š</p><ul><li>ç¬¬ä¸€ç§ï¼š å¦‚æœé‡åˆ°ç»„ä»¶ï¼Œè€Œä¸”æ›´æ–°ä¸æ¶‰åŠå½“å‰ç»„ä»¶ï¼Œä¹Ÿä¸åœ¨å½“å‰ç»„ä»¶çš„çˆ¶å­é€’å½’é“¾ä¸Šï¼Œé‚£ä¹ˆå°±ä¸ä¼š renderï¼Œä¹Ÿä¸ä¼šå‘ä¸‹ beginWork ã€‚</li><li>ç¬¬äºŒç§ï¼š å¦‚æœé‡åˆ°ç»„ä»¶ï¼Œè€Œä¸”æ›´æ–°ä¸æ¶‰åŠå½“å‰ç»„ä»¶ï¼Œä½†æ˜¯æ›´æ–°ç»„ä»¶å±äºå½“å‰ç»„ä»¶çš„å­å­™åä»£ï¼Œé‚£ä¹ˆä¸ä¼š renderï¼Œä½†æ˜¯ä¼šå‘ä¸‹ beginWork ï¼Œç›®çš„å¾ˆæ˜ç¡®ï¼Œæ‰¾åˆ°å¯¹åº”çš„æ›´æ–°ç»„ä»¶ã€‚</li><li>ç¬¬ä¸‰ç§ï¼š å¦‚æœé‡åˆ°å…¶ä»–ç±»å‹çš„ fiber æ¯”å¦‚ hostComponent <code>&lt;div&gt;</code>ï¼Œé‚£ä¹ˆä¼šå¯¹æ¯”å½“å‰çš„æ›´æ–°ä¼˜å…ˆçº§ï¼Œå¦‚æœä½ä¼˜å…ˆçº§ï¼Œé‚£ä¹ˆä¸éœ€è¦å‘ä¸‹ beginWork ã€‚åä¹‹å‘ä¸‹ beginWorkã€‚</li></ul><p>è¿™ä¹ˆè¯´å¯èƒ½å¤§å®¶ä¸æ˜¯å¾ˆç†è§£ï¼Œæˆ‘ä¸¾ä¸€ä¸ªä¾‹å­ï¼š</p><p>å¦‚ä¸‹å½“ç‚¹å‡» componentB ä¸‹é¢çš„ span è§¦å‘ setState æ›´æ–° ï¼Œå¦‚ä¸‹å¯ä»¥æ¸…æ™°çœ‹è§ beginWork å’Œ render æµç¨‹ã€‚</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4be69acfeb8d42c68249f96b8bbb7b98~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="context8.jpg"></p><ul><li>ä» root å¼€å§‹ç¬¬ä¸€æ¬¡è°ƒå’Œï¼Œ ä¸‰ä¸ª fiber éƒ½ä¼šç»å† beginWork ï¼Œé€šè¿‡å¯¹æ¯”ä¼˜å…ˆçº§ï¼Œ <code>componentA</code> å’Œ <code>div</code> åœæ­¢å‘ä¸‹ beginworkã€‚</li><li>æ›´æ–°å‘ç”Ÿåœ¨ componentB ï¼Œæ‰€ä»¥ componentB æ¸²æŸ“ï¼Œè§¦å‘ <code>render</code> ï¼Œå¾—åˆ°æ–°çš„ elementï¼Œé€šè¿‡å¯¹æ¯”ï¼Œ <code>div</code> <code>span</code> éƒ½ä¼š beginworkã€‚</li><li>componentC ç”±äºçˆ¶ç»„ä»¶æ›´æ–°ï¼Œæ²¡æœ‰ä»»ä½•ä¼˜åŒ–ç­–ç•¥çš„æƒ…å†µï¼Œé‚£ä¹ˆä¹Ÿä¼šè·Ÿç€ <code>render</code>ï¼Œæ¥ç€ div ä¹Ÿä¼šè·Ÿç€ <code>beginwork</code>ã€‚</li></ul><p>é‚£ä¹ˆå¦‚ä¸Šï¼Œå¦‚æœ componentC é€šè¿‡ <code>PureComponent</code> æˆ–è€… <code>shouldComponentUpdate</code> é™åˆ¶æ›´æ–°ä¹‹åã€‚é‚£ä¹ˆä¼šå˜æˆå¦‚ä¸‹çš„æ ·å­ï¼š</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/76bac2d4e134455dbdf31fa33cd7f27b~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="context9.jpg"></p><ul><li>å¦‚ä¸Š componentC é€šè¿‡ <code>PureComponent</code> å¤„ç†åï¼Œä¸å† render ï¼Œå½“ç„¶ä¹Ÿä¸ä¼šå†å‘ä¸‹ beginworkã€‚</li></ul><p>æ¥ä¸‹æ¥ï¼Œå¦‚æœç‚¹å‡» componentC ä¸‹çš„ divï¼Œè§¦å‘ setState æ›´æ–°ï¼Œé‚£ä¹ˆåˆä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ</p><ul><li>æ­¤æ—¶æ›´æ–°å‘ç”Ÿåœ¨ <code>componentC</code> ä¸Šï¼Œæ‰€ä»¥ componentB åªä¼šå‘ç”Ÿ beginwork ï¼Œä¸ä¼šå‘ç”Ÿ renderã€‚</li><li><code>componentB</code> ä¸‹é¢çš„ <code>div</code> ä¼šåœæ­¢å‘ä¸‹çš„ beiginwork ã€‚</li></ul><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/015b6ad8e1404fae88319b150cd05451~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="context10.jpg"></p><p><strong>æˆ‘ä»¬æ€»ç»“æµç¨‹å¦‚ä¸‹ï¼š</strong></p><ul><li>1 å¦‚æœä¸€ä¸ªç»„ä»¶å‘ç”Ÿæ›´æ–°ï¼Œé‚£ä¹ˆå½“å‰ç»„ä»¶åˆ° fiber root ä¸Šçš„çˆ¶çº§é“¾ä¸Šçš„æ‰€æœ‰ fiber ï¼Œæ›´æ–°ä¼˜å…ˆçº§éƒ½ä¼šå‡é«˜ï¼Œéƒ½ä¼šè§¦å‘ beginwork ã€‚</li><li>2 render ä¸ç­‰äº beginWorkï¼Œä½†æ˜¯ render å‘ç”Ÿï¼Œä¸€å®šè§¦å‘äº† beginwork ã€‚</li><li>3 ä¸€æ¬¡ beginwork ï¼Œä¸€ä¸ª fiber ä¸‹çš„åŒçº§å…„å¼Ÿ fiber ä¼šå‘ç”Ÿå¯¹æ¯”ï¼Œæ‰¾åˆ°ä»»åŠ¡ä¼˜å…ˆçº§é«˜çš„ fiber ã€‚å‘ä¸‹ beginwork ã€‚</li></ul><p>å¯¹äº beginwork çš„æµç¨‹ï¼Œæ¥ä¸‹æ¥ä¼šæœ‰ä¸“é—¨çš„ç« èŠ‚ç»´æŠ¤ã€‚</p><p><strong>Context åŸç†</strong></p><p>æ¥ä¸‹æ¥è¨€å½’æ­£ä¼ ï¼Œæˆ‘ä»¬æ¥ç ”ç©¶ä¸€ä¸‹ context çš„æ›´æ–°åŸç†ï¼Œä¸Šé¢è¯´åˆ° <code>Provider</code> æ›´æ–°ï¼Œä¼šé€’å½’æ‰€æœ‰çš„å­ç»„ä»¶ï¼Œåªè¦æ¶ˆè´¹äº† context çš„å­ä»£ fiber ï¼Œéƒ½ä¼šç»™ä¸€ä¸ªé«˜ä¼˜å…ˆçº§ã€‚è€Œä¸”å‘ä¸Šæ›´æ–°çˆ¶çº§ fiber é“¾ä¸Šçš„ä¼˜å…ˆçº§ï¼Œè®©æ‰€æœ‰çˆ¶çº§ fiber éƒ½å¤„äºä¸€ä¸ªé«˜ä¼˜å…ˆçº§ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥é«˜ä¼˜å…ˆçº§çš„ fiber éƒ½ä¼š beginWork ã€‚</p><p>é‚£ä¹ˆå°†ä¸Šè¿°ä¾‹å­è¿›è¡Œä¿®æ”¹ï¼Œ<code>propagateContextChange</code> çš„æµç¨‹ä¼šä¸‹å¦‚ä¸‹ä¸€æ ·ï¼ŒæŠŠçˆ¶çº§ fiber çš„ä¼˜å…ˆçº§æé«˜ã€‚</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/84210209b512493889a9d2c3a066324e~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="context11.jpg"></p><p>é‚£ä¹ˆæ•´ä¸ª fiber æ›´æ–°æµç¨‹ä¼šåƒå¦‚ä¸‹ä¸€æ ·</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/761505beb9664b09a27599550b6a0cf7~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="context12.jpg"></p><h3 id="_2-consumer" tabindex="-1">2 Consumer â€‹</h3><p>æˆ‘ä»¬å·²ç»è®²äº† Provider æ ¸å¿ƒåŸç†ï¼Œè¿˜æœ‰å¦å¤–ä¸€éƒ¨åˆ†å°±æ˜¯ Consumer ï¼Œç ”ç©¶ä¸€ä¸‹å…¶åŸç†ã€‚</p><h4 id="consumer-æµç¨‹" tabindex="-1">Consumer æµç¨‹ â€‹</h4><p>ä¸Šæ–‡è¯´é“ï¼ŒConsumer æœ¬è´¨ä¸Šæ˜¯ç±»å‹ä¸º <code>REACT_CONTEXT_TYPE</code> çš„ element å¯¹è±¡ã€‚åœ¨è°ƒå’Œé˜¶æ®µï¼Œä¼šè½¬åŒ–æˆ <code>ContextConsumer</code> ç±»å‹çš„ fiber å¯¹è±¡ã€‚åœ¨ beginwork ä¸­ï¼Œä¼šè°ƒç”¨ <code>updateContextConsumer</code> æ–¹æ³•ã€‚é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•åšäº†äº›ä»€ä¹ˆå‘¢ï¼Ÿ</p><blockquote><p>react/react-reconcider/src/ReactFiberBeginWork.js</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> updateContextConsumer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">current</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">workInProgress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">renderExpirationTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context  </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> workInProgress.type;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> newProps</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> workInProgress.pendingProps;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* å¾—åˆ° render props children */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> render</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> newProps.children;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* è¯»å– context */</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  prepareToReadContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(workInProgress, renderExpirationTime);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* å¾—åˆ°æœ€æ–°çš„æ–°çš„ context value */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> newValue</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> readContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(context, newProps.unstable_observedBits);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> newChildren;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* å¾—åˆ°æœ€æ–°çš„ children element */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  newChildren </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> render</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(newValue);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  workInProgress.effectTag </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PerformedWork;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* è°ƒå’Œ children */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  reconcileChildren</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(current, workInProgress, newChildren, renderExpirationTime);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> workInProgress.child;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><code>updateContextConsumer</code>çš„æ ¸å¿ƒæµç¨‹ï¼š</p><ul><li>é¦–å…ˆè°ƒç”¨ <code>readContext</code> è·å–æœ€æ–°çš„ value ã€‚</li><li>ç„¶åé€šè¿‡ <code>render props</code> å‡½æ•°ï¼Œä¼ å…¥æœ€æ–°çš„ valueï¼Œå¾—åˆ°æœ€æ–°çš„ <code>children</code> ã€‚</li><li>æ¥ä¸‹æ¥è°ƒå’Œ <code>children</code> ã€‚</li></ul><p>é‚£ä¹ˆæœ‰ä¸€ä¸ªé—®é¢˜<strong>å°±æ˜¯ fiber ä¸Šçš„ dependencies å¦‚ä½•å’Œ context å»ºç«‹èµ·å…³è”</strong>ã€‚ é‚£ä¹ˆå°±æ˜¯ <code>readContext</code> è¿™ä¸ªå‡½æ•°åšçš„äº‹ï¼Œå¯ä»¥æå‰é€éœ²ä¸€ä¸‹ï¼ŒuseContext å’Œ contextType æœ¬è´¨ä¸Šä¹Ÿæ˜¯</p><h4 id="readcontext" tabindex="-1">readContext â€‹</h4><p>readContext æ˜¯é™¤äº† <code>Provider</code> ä¹‹å¤–ï¼Œç¬¬äºŒä¸ªæ ¸å¿ƒçŸ¥è¯†ç‚¹ã€‚</p><blockquote><p>react/react-reconcider/src/ReactFiberNewContext.js</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> readContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">( </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">observedBits</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ){</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* åˆ›å»ºä¸€ä¸ª contextItem */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> contextItem</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      context,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      observedBits: resolvedObservedBits,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      next: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    };</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* ä¸å­˜åœ¨æœ€åä¸€ä¸ª context Dependency  */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (lastContextDependency </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      lastContextDependency </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> contextItem;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      currentlyRenderingFiber.dependencies </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        expirationTime: NoWork,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        firstContext: contextItem,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        responders: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      /* å­˜åœ¨çš„æƒ…å†µ */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      lastContextDependency </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lastContextDependency.next </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> contextItem;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> isPrimaryRenderer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context._currentValue </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context._currentValue2;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li>readContext ä¸»è¦åšçš„äº‹æƒ…æ˜¯è¿™æ ·çš„ï¼Œé¦–å…ˆä¼šåˆ›å»ºä¸€ä¸ª contextItem ï¼Œä¸Šè¿°è¯´åˆ°è¿‡ fiber ä¸Šä¼šå­˜åœ¨å¤šä¸ª <code>dependencies</code> ï¼Œå®ƒä»¬ä»¥é“¾è¡¨çš„å½¢å¼è”ç³»åˆ°ä¸€èµ·ï¼Œå¦‚æœä¸å­˜åœ¨æœ€åä¸€ä¸ª <code>context dependency</code> ï¼Œé‚£è¯æ˜ context dependencies ä¸ºç©º ï¼Œé‚£ä¹ˆä¼šåˆ›å»ºç¬¬ä¸€ä¸ª dependency ï¼Œå¦‚æœå­˜åœ¨æœ€åä¸€ä¸ª dependency ï¼Œé‚£ä¹ˆ contextItem ä¼šä»¥é“¾è¡¨å½¢å¼ä¿å­˜ï¼Œå¹¶å˜æˆæœ€åä¸€ä¸ª lastContextDependency ã€‚</li></ul><h4 id="å¤šä¸ª-provider-åµŒå¥—" tabindex="-1">å¤šä¸ª Provider åµŒå¥— â€‹</h4><p>å¦‚æœæœ‰å¤šä¸ª Provider çš„æƒ…å†µï¼Œé‚£ä¹ˆåä¸€ä¸ª contextValue ä¼šè¦†ç›–å‰ä¸€ä¸ª contextValueï¼Œåœ¨å¼€å‘è€…è„‘æµ·ä¸­ï¼Œè¦æœ‰ä¸€ä¸ªå®šå¾‹å°±æ˜¯ï¼š<strong><code>Provider</code> æ˜¯ç”¨æ¥ä¼ é€’ valueï¼Œè€Œéä¿å­˜ value</strong> ã€‚</p><h3 id="_3-contexttype-å’Œ-usecontext" tabindex="-1">3 contextType å’Œ useContext â€‹</h3><h4 id="usecontext-åŸç†" tabindex="-1">useContext åŸç† â€‹</h4><p><code>useContext</code> åŸç†ï¼Œè°ƒç”¨ useContext æœ¬è´¨ä¸Šè°ƒç”¨ <code>readContext</code> æ–¹æ³•ã€‚</p><blockquote><p>react/react-reconcider/src/ReactFiberHooks.js</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> HooksDispatcherOnMount</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    useContext: readContext</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li>å‡½æ•°ç»„ä»¶é€šè¿‡ readContext ï¼Œå°†å‡½æ•°ç»„ä»¶çš„ <code>dependencies</code> å’Œå½“å‰ context å»ºç«‹èµ·å…³è”ï¼Œcontext æ”¹å˜ï¼Œå°†å½“å‰å‡½æ•°ç»„ä»¶è®¾ç½®é«˜ä¼˜å…ˆçº§ï¼Œä¿ƒä½¿å…¶æ¸²æŸ“ã€‚</li></ul><h4 id="contexttype-åŸç†" tabindex="-1">contextType åŸç† â€‹</h4><p>ç±»ç»„ä»¶çš„é™æ€å±æ€§ <code>contextType</code> å’Œ useContext ä¸€æ ·ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯è°ƒç”¨ readContext æ–¹æ³•ã€‚</p><blockquote><p>react/react-reconcider/src/ReactFiberClassComponent.js</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> constructClassInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">workInProgress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">props</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">     if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> contextType </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;object&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> contextType </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         /* è¯»å– context  */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        context </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> readContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(contextType);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> instance</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ctor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(props, context);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li>é™æ€å±æ€§ contextType ï¼Œåœ¨ç±»ç»„ä»¶å®ä¾‹åŒ–çš„æ—¶å€™è¢«ä½¿ç”¨ï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯è°ƒç”¨ <code>readContext</code>å°† context å’Œ fiber ä¸Šçš„ <code>dependencies</code> å»ºç«‹èµ·å…³è”ã€‚</li></ul><h3 id="_4-context-æµç¨‹æ€»ç»“" tabindex="-1">4 Context æµç¨‹æ€»ç»“ â€‹</h3><p>ä¸‹é¢å¯¹æ•´ä¸ª context åŸç†éƒ¨åˆ†åšæ€»ç»“ã€‚</p><ul><li><p>Provider ä¼ é€’æµç¨‹ï¼šProvider çš„æ›´æ–°ï¼Œä¼šæ·±åº¦éå†å­ä»£ fiberï¼Œæ¶ˆè´¹ context çš„ fiber å’Œçˆ¶çº§é“¾éƒ½ä¼šæå‡æ›´æ–°ä¼˜å…ˆçº§ã€‚ å¯¹äºç±»ç»„ä»¶çš„ fiber ï¼Œä¼š forceUpdate å¤„ç†ã€‚æ¥ä¸‹æ¥æ‰€æœ‰æ¶ˆè´¹çš„ fiberï¼Œéƒ½ä¼š beginWork ã€‚</p></li><li><p>context è®¢é˜…æµç¨‹ï¼š <code>contextType</code> ï¼Œ <code>useContext</code>ï¼Œ <code>Consumer</code> ä¼šå†…éƒ¨è°ƒç”¨ <code>readContext</code> ï¼ŒreadContext ä¼šæŠŠ fiber ä¸Šçš„ <code>dependencies</code> å±æ€§å’Œ context å¯¹è±¡å»ºç«‹èµ·å…³è”ã€‚</p></li></ul><h3 id="_5-æ€»ç»“" tabindex="-1">5 æ€»ç»“ â€‹</h3><p>æœ¬ç« èŠ‚çŸ¥è¯†ç‚¹æ€»ç»“:</p><ul><li>context åŸç†ï¼ŒProvider åšäº†äº›ä»€ä¹ˆã€‚</li><li>beginWork å’Œ render çš„æ›´æ–°åŸåˆ™å’ŒåŒºåˆ«ã€‚</li><li>ä¸‰ç§ context ä¼ é€’æ¨¡å¼åŸç†ã€‚</li><li>context è®¢é˜…æ¶ˆè´¹åŸç†ã€‚</li><li>Provider åµŒå¥—ä¼ é€’åŸç†ã€‚</li></ul><p>é€æ¼ä¸€ä¸‹ï¼Œæ¥ä¸‹æ¥ä¼šæ›´æ–°å¦å¤–ä¸€ä¸ªæ–°çš„ç« èŠ‚ fiber åˆå§‹åŒ–å’Œè°ƒå’Œæµç¨‹ã€‚</p>`,104),p=[t];function l(h,k,r,d,o,c){return e(),i("div",null,p)}const x=s(a,[["render",l]]);export{C as __pageData,x as default};
