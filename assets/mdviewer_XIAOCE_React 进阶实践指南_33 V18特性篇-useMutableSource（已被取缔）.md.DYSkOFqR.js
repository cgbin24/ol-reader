import{_ as s}from"./app.BdTF1atn.js";import{j as i,i as a,Z as n}from"./chunks/@vue.D6nrJjhM.js";/* empty css                          */import"./chunks/@vueuse.ErXst1iV.js";const F=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"mdviewer/XIAOCE/React è¿›é˜¶å®è·µæŒ‡å—/33 V18ç‰¹æ€§ç¯‡-useMutableSourceï¼ˆå·²è¢«å–ç¼”ï¼‰.md","filePath":"mdviewer/XIAOCE/React è¿›é˜¶å®è·µæŒ‡å—/33 V18ç‰¹æ€§ç¯‡-useMutableSourceï¼ˆå·²è¢«å–ç¼”ï¼‰.md"}'),t={name:"mdviewer/XIAOCE/React è¿›é˜¶å®è·µæŒ‡å—/33 V18ç‰¹æ€§ç¯‡-useMutableSourceï¼ˆå·²è¢«å–ç¼”ï¼‰.md"},e=n(`<h2 id="è¿‡æ—¶çš„-react-api" tabindex="-1">è¿‡æ—¶çš„ React API â€‹</h2><h3 id="ä¸€-å‰è¨€" tabindex="-1">ä¸€ å‰è¨€ â€‹</h3><p><code>useMutableSource</code> æœ€æ—©çš„ RFC ææ¡ˆåœ¨ 2020å¹´ 2 æœˆä»½å°±å¼€å§‹äº†ã€‚åœ¨ React 18 ä¸­å®ƒå°†ä½œä¸ºæ–°ç‰¹æ€§å‡ºç°ã€‚ç”¨ä¸€æ®µææ¡ˆä¸­çš„æè¿°æ¥æ¦‚æ‹¬ <code>useMutableSource</code>ã€‚</p><blockquote><p>useMutableSource èƒ½å¤Ÿè®© React ç»„ä»¶åœ¨ Concurrent Mode æ¨¡å¼ä¸‹å®‰å…¨åœ°æœ‰æ•ˆåœ°è¯»å–å¤–æ¥æ•°æ®æºï¼Œåœ¨ç»„ä»¶æ¸²æŸ“è¿‡ç¨‹ä¸­èƒ½å¤Ÿæ£€æµ‹åˆ°å˜åŒ–ï¼Œå¹¶ä¸”åœ¨æ•°æ®æºå‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œèƒ½å¤Ÿè°ƒåº¦æ›´æ–°ã€‚</p></blockquote><p>è¯´èµ·å¤–éƒ¨æ•°æ®æºå°±è¦ä» state å’Œæ›´æ–°è¯´èµ· ï¼Œæ— è®ºæ˜¯ React è¿˜æ˜¯ Vue è¿™ç§ä¼ ç»Ÿ UI æ¡†æ¶ä¸­ï¼Œè™½ç„¶å®ƒä»¬éƒ½é‡‡ç”¨è™šæ‹Ÿ DOM æ–¹å¼ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸èƒ½å¤ŸæŠŠæ›´æ–°å•å…ƒå§”æ‰˜åˆ°è™šæ‹Ÿ DOM èº«ä¸Šæ¥ï¼Œæ‰€ä»¥æ›´æ–°çš„æœ€å°ç²’åº¦è¿˜æ˜¯åœ¨ç»„ä»¶å±‚é¢ä¸Šï¼Œç”±ç»„ä»¶ç»Ÿä¸€ç®¡ç†æ•°æ® stateï¼Œå¹¶å‚ä¸è°ƒåº¦æ›´æ–°ã€‚</p><p>å›åˆ°æˆ‘ä»¬çš„ä¸»è§’ React ä¸Šï¼Œæ—¢ç„¶ç”±ç»„ä»¶ component ç®¡æ§ç€çŠ¶æ€ stateã€‚é‚£ä¹ˆåœ¨ v17 å’Œä¹‹å‰çš„ç‰ˆæœ¬ï¼ŒReact æƒ³è¦è§†å›¾ä¸Šçš„æ›´æ–°ï¼Œé‚£ä¹ˆåªèƒ½é€šè¿‡æ›´æ”¹å†…éƒ¨æ•°æ® state ã€‚çºµè§ˆ React çš„å‡ ç§æ›´æ–°æ–¹å¼ï¼Œæ— ä¸€ç¦»ä¸å¼€è‡ªèº« state ã€‚å…ˆæ¥çœ‹ä¸€ä¸‹ React çš„å‡ ç§æ›´æ–°æ¨¡å¼ã€‚</p><ul><li>ç»„ä»¶æœ¬èº«æ”¹å˜ state ã€‚å‡½æ•° <code>useState</code> | <code>useReducer</code> ï¼Œç±»ç»„ä»¶ <code>setState</code> | <code>forceUpdate</code> ã€‚</li><li><code>props</code> æ”¹å˜ï¼Œç”±ç»„ä»¶æ›´æ–°å¸¦æ¥çš„å­ç»„ä»¶çš„æ›´æ–°ã€‚</li><li><code>context</code> æ›´æ–°ï¼Œå¹¶ä¸”è¯¥ç»„ä»¶æ¶ˆè´¹äº†å½“å‰ <code>context</code> ã€‚</li></ul><p>æ— è®ºæ˜¯ä¸Šé¢å“ªç§æ–¹å¼ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯ state çš„å˜åŒ–ã€‚</p><ul><li><code>props</code> æ”¹å˜æ¥æºäºçˆ¶çº§ç»„ä»¶çš„ <code>state</code> å˜åŒ–ã€‚</li><li><code>context</code> å˜åŒ–æ¥æºäº Provider ä¸­ value å˜åŒ–ï¼Œè€Œ value ä¸€èˆ¬æƒ…å†µä¸‹ä¹Ÿæ˜¯ state æˆ–è€…æ˜¯ state è¡ç”Ÿäº§ç‰©ã€‚</li></ul><p>ä»ä¸Šé¢å¯ä»¥æ¦‚æ‹¬å‡ºï¼šstateå’Œè§†å›¾æ›´æ–°çš„å…³ç³» <code>Model =&gt; View</code> ã€‚ä½†æ˜¯ state ä»…é™äºç»„ä»¶å†…éƒ¨çš„æ•°æ®ï¼Œå¦‚æœ state æ¥æºäºå¤–éƒ¨ï¼ˆè„±ç¦»ç»„ä»¶å±‚é¢ï¼‰ã€‚é‚£ä¹ˆå¦‚ä½•å®Œæˆå¤–éƒ¨æ•°æ®æºè½¬æ¢æˆå†…éƒ¨çŠ¶æ€ï¼Œ å¹¶ä¸”æ•°æ®æºå˜åŒ–ï¼Œç»„ä»¶é‡æ–° render å‘¢ï¼Ÿ</p><p>å¸¸è§„æ¨¡å¼ä¸‹ï¼Œå…ˆæŠŠå¤–éƒ¨æ•°æ® external Data é€šè¿‡ selector é€‰æ‹©å™¨æŠŠç»„ä»¶éœ€è¦çš„æ•°æ®æ˜ å°„åˆ° state | props ä¸Šã€‚è¿™ç®—æ˜¯å®Œæˆäº†ä¸€æ­¥ï¼Œæ¥ä¸‹æ¥è¿˜éœ€è¦ subscribe è®¢é˜…å¤–éƒ¨æ•°æ®æºçš„å˜åŒ–ï¼Œå¦‚æœå‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆè¿˜éœ€è¦è‡ªèº«å»å¼ºåˆ¶æ›´æ–° forceUpdate ã€‚ä¸‹é¢ä¸¤å¹…å›¾è¡¨ç¤ºæ•°æ®æ³¨å…¥å’Œæ•°æ®è®¢é˜…æ›´æ–°ã€‚</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0734aca032e046d58d9c263b6d3d5cb3~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="1.jpg" loading="lazy"></p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dd8b70d275ad4f8aa84f18f4029960ea~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="2.jpg" loading="lazy"></p><p>å…¸å‹çš„å¤–éƒ¨æ•°æ®æºå°±æ˜¯ redux ä¸­çš„ store ï¼Œredux æ˜¯å¦‚ä½•æŠŠ Store ä¸­çš„ state ï¼Œå®‰å…¨çš„å˜æˆç»„ä»¶çš„ state çš„ã€‚</p><p>æˆ–è®¸æˆ‘å¯ä»¥ç”¨ä¸€æ®µä»£ç æ¥è¡¨ç¤ºä» react-redux ä¸­ state æ”¹å˜åˆ°è§†å›¾æ›´æ–°çš„æµç¨‹ã€‚</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> store</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createStore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(reducer,initState)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> App</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">selector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">state</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> , </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">setReduxState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> React.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">useState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({})</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> contextValue</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useMemo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* è®¢é˜… store å˜åŒ– */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        store.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">subscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             /* ç”¨é€‰æ‹©å™¨é€‰æ‹©è®¢é˜… state */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">             const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> selector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             /* å¦‚æœå‘ç”Ÿå˜åŒ–  */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">             if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ifHasChange</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(state,value)){</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                 setReduxState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(value)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">             }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },[ store ])    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;...&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>ä½†æ˜¯ä¾‹å­ä¸­ä»£ç ï¼Œæ²¡æœ‰å®é™…æ„ä¹‰ï¼Œä¹Ÿä¸æ˜¯æºä»£ç ï¼Œæˆ‘è¿™é‡Œå°±æ˜¯è®©å¤§å®¶æ¸…æ™°åœ°äº†è§£æµç¨‹ã€‚redux å’Œ react æœ¬è´¨ä¸Šæ˜¯è¿™æ ·å·¥ä½œçš„ã€‚</p><ul><li>é€šè¿‡ store.subscribe æ¥è®¢é˜… state å˜åŒ–ï¼Œä½†æ˜¯æœ¬è´¨ä¸Šè¦æ¯”ä»£ç ç‰‡æ®µä¸­å¤æ‚çš„å¤šï¼Œé€šè¿‡ selector ï¼ˆé€‰æ‹©å™¨ï¼‰æ‰¾åˆ°ç»„ä»¶éœ€è¦çš„ stateã€‚ æˆ‘åœ¨è¿™é‡Œå…ˆè§£é‡Šä¸€ä¸‹<strong>selector</strong>ï¼Œå› ä¸ºåœ¨ä¸šåŠ¡ç»„ä»¶å¾€å¾€ä¸éœ€è¦æ•´ä¸ª store ä¸­çš„ state å…¨éƒ¨æ•°æ®ï¼Œè€Œæ˜¯ä»…ä»…éœ€è¦ä¸‹é¢çš„éƒ¨åˆ†çŠ¶æ€ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ä» state ä¸­é€‰æ‹©â€˜æœ‰ç”¨çš„â€™ï¼Œå¹¶ä¸”å’Œ props åˆå¹¶ï¼Œç»†å¿ƒçš„åŒå­¦åº”è¯¥å‘ç°ï¼Œé€‰æ‹©å™¨éœ€è¦å’Œ <code>react-redux</code> ä¸­ connect ç¬¬ä¸€å‚æ•° <code>mapStateToProps</code> è”åŠ¨ã€‚å¯¹äºç»†èŠ‚ï¼Œæ— å…³ç´§è¦ï¼Œå› ä¸ºä»Šå¤©é‡ç‚¹æ˜¯ <code>useMutableSource</code>ã€‚</li></ul><p>å¦‚ä¸Šæ˜¯æ²¡æœ‰ useMutableSource çš„æƒ…å†µï¼Œç°åœ¨ç”¨ useMutableSource ä¸åœ¨éœ€è¦æŠŠè®¢é˜…åˆ°æ›´æ–°æµç¨‹äº¤ç»™ç»„ä»¶å¤„ç†ã€‚å¦‚ä¸‹ï¼š</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* åˆ›å»º store */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> store</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createStore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(reducer,initState)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* åˆ›å»ºå¤–éƒ¨æ•°æ®æº */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> externalDataSource</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createMutableSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">( store ,store.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() )</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* è®¢é˜…æ›´æ–° */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> subscribe</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">store</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">callback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> store.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">subscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(callback);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> App</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">selector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }){</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* è®¢é˜…çš„ state å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆç»„ä»¶ä¼šæ›´æ–° */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> state</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useMutableSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(externalDataSource,selector,subscribe)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li>é€šè¿‡ createMutableSource åˆ›å»ºå¤–éƒ¨æ•°æ®æºï¼Œé€šè¿‡ useMutableSource æ¥ä½¿ç”¨å¤–éƒ¨æ•°æ®æºã€‚å¤–éƒ¨æ•°æ®æºå˜åŒ–ï¼Œç»„ä»¶è‡ªåŠ¨æ¸²æŸ“ã€‚</li></ul><p>å¦‚ä¸Šæ˜¯é€šè¿‡ useMutableSource å®ç°çš„è®¢é˜…æ›´æ–°ï¼Œè¿™æ ·å‡å°‘äº† APP å†…éƒ¨ç»„ä»¶ä»£ç ï¼Œä»£ç å¥å£®æ€§æå‡ï¼Œä¸€å®šç¨‹åº¦ä¸Šä¹Ÿé™ä½äº†è€¦åˆã€‚æ¥ä¸‹æ¥è®©æˆ‘ä»¬å…¨æ–¹é¢è®¤è¯†ä¸€ä¸‹è¿™ä¸ª V18 çš„æ–°ç‰¹æ€§ã€‚</p><h3 id="äºŒ-åŠŸèƒ½ä»‹ç»" tabindex="-1">äºŒ åŠŸèƒ½ä»‹ç» â€‹</h3><p>å…·ä½“åŠŸèƒ½ä»‹ç»æµç¨‹è¿˜æ˜¯å‚è€ƒæœ€æ–°çš„ RFCï¼Œ createMutableSource å’Œ useMutableSource åœ¨ä¸€å®šçš„ç¨‹åº¦ä¸Šï¼Œæœ‰ç‚¹åƒ <code>createContext</code> å’Œ <code>useContext</code> ï¼Œè§åçŸ¥æ„ï¼Œå°±æ˜¯<strong>åˆ›å»ºä¸ä½¿ç”¨</strong>ã€‚ä¸åŒçš„æ˜¯ context éœ€è¦ Provider å»æ³¨å…¥å†…éƒ¨çŠ¶æ€ï¼Œè€Œä»Šå¤©çš„ä¸»è§’æ˜¯æ³¨å…¥å¤–éƒ¨çŠ¶æ€ã€‚é‚£ä¹ˆé¦–å…ˆåº”è¯¥çœ‹ä¸€ä¸‹ä¸¤è€…å¦‚ä½•ä½¿ç”¨ã€‚</p><h4 id="åˆ›å»º" tabindex="-1">åˆ›å»º â€‹</h4><p>createMutableSource åˆ›å»ºä¸€ä¸ªæ•°æ®æºã€‚å®ƒæœ‰ä¸¤ä¸ªå‚æ•°ï¼š</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> externalDataSource</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createMutableSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">( store ,store.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() )</span></span></code></pre></div><ul><li>ç¬¬ä¸€ä¸ªå‚æ•°ï¼šå°±æ˜¯å¤–éƒ¨çš„æ•°æ®æºï¼Œæ¯”å¦‚ redux ä¸­çš„ store,</li><li>ç¬¬äºŒä¸ªå‚æ•°ï¼šä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°çš„è¿”å›å€¼ä½œä¸ºæ•°æ®æºçš„ç‰ˆæœ¬å·ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„âš ï¸çš„æ˜¯ï¼Œè¦ä¿æŒæ•°æ®æºå’Œæ•°æ®ç‰ˆæœ¬å·çš„ä¸€è‡´æ€§ï¼Œå°±æ˜¯æ•°æ®æºå˜åŒ–äº†ï¼Œé‚£ä¹ˆæ•°æ®ç‰ˆæœ¬å·å°±è¦å˜åŒ–ï¼Œä¸€å®šç¨‹åº¦ä¸Šéµå¾ª <code>immutable</code> åŸåˆ™ï¼ˆä¸å¯å˜æ€§ï¼‰ã€‚å¯ä»¥ç†è§£ä¸ºæ•°æ®ç‰ˆæœ¬å·æ˜¯è¯æ˜æ•°æ®æºå”¯ä¸€æ€§çš„æ ‡ç¤ºã€‚</li></ul><h4 id="apiä»‹ç»" tabindex="-1">apiä»‹ç» â€‹</h4><p>useMutableSource å¯ä»¥ä½¿ç”¨éä¼ ç»Ÿçš„æ•°æ®æºã€‚å®ƒçš„åŠŸèƒ½å’Œ Context API è¿˜æœ‰ useSubscription ç±»ä¼¼ã€‚ï¼ˆæ²¡æœ‰ä½¿ç”¨è¿‡ useSubscription çš„åŒå­¦ï¼Œå¯ä»¥äº†è§£ä¸€ä¸‹ ï¼‰ã€‚</p><p>å…ˆæ¥çœ‹ä¸€ä¸‹ useMutableSource çš„åŸºæœ¬ä½¿ç”¨ï¼š</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useMutableSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(source,getSnapShot,subscribe)</span></span></code></pre></div><p>useMutableSource æ˜¯ä¸€ä¸ª hooks ï¼Œå®ƒæœ‰ä¸‰ä¸ªå‚æ•°ï¼š</p><ul><li><code>sourceï¼šMutableSource &lt; Source &gt;</code> å¯ä»¥ç†è§£ä¸ºå¸¦è®°å¿†çš„æ•°æ®æºå¯¹è±¡ã€‚</li><li><code>getSnapshotï¼š( source : Source ) =&gt; Snapshot</code> ï¼šä¸€ä¸ªå‡½æ•°ï¼Œæ•°æ®æºä½œä¸ºå‡½æ•°çš„å‚æ•°ï¼Œè·å–å¿«ç…§ä¿¡æ¯ï¼Œå¯ä»¥ç†è§£ä¸º selector ï¼ŒæŠŠå¤–éƒ¨çš„æ•°æ®æºçš„æ•°æ®è¿‡æ»¤ï¼Œæ‰¾å‡ºæƒ³è¦çš„æ•°æ®æºã€‚</li><li><code>subscribe: (source: Source, callback: () =&gt; void) =&gt; () =&gt; void</code>ï¼šè®¢é˜…å‡½æ•°ï¼Œæœ‰ä¸¤ä¸ªå‚æ•°ï¼ŒSource å¯ä»¥ç†è§£ä¸º useMutableSource ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œcallback å¯ä»¥ç†è§£ä¸º useMutableSource ç¬¬äºŒä¸ªå‚æ•°ï¼Œå½“æ•°æ®æºå˜åŒ–çš„æ—¶å€™ï¼Œæ‰§è¡Œå¿«ç…§ï¼Œè·å–æ–°çš„æ•°æ®ã€‚</li></ul><p><strong>useMutableSource ç‰¹ç‚¹</strong></p><p>useMutableSource å’Œ useSubscription åŠŸèƒ½ç±»ä¼¼ï¼š</p><ul><li>ä¸¤è€…éƒ½éœ€è¦å¸¦æœ‰è®°å¿†åŒ–çš„â€˜é…ç½®åŒ–å¯¹è±¡â€™ï¼Œä»è€Œä»å¤–éƒ¨å–å€¼ã€‚</li><li>ä¸¤è€…éƒ½éœ€è¦ä¸€ç§è®¢é˜…å’Œå–æ¶ˆè®¢é˜…æºçš„æ–¹æ³• <code>subscribe</code>ã€‚</li></ul><p>é™¤æ­¤ä¹‹å¤– useMutableSource è¿˜æœ‰ä¸€äº›ç‰¹ç‚¹ï¼š</p><ul><li>useMutableSource éœ€è¦æºä½œä¸ºæ˜¾å¼å‚æ•°ã€‚ä¹Ÿå°±æ˜¯éœ€è¦æŠŠæ•°æ®æºå¯¹è±¡ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥ã€‚</li><li>useMutableSource ç”¨ getSnapshot è¯»å–çš„æ•°æ®ï¼Œæ˜¯ä¸å¯å˜çš„ã€‚</li></ul><p><strong>å…³äº MutableSource ç‰ˆæœ¬å·</strong></p><p><code>useMutableSource</code> ä¼šè¿½è¸ª MutableSource çš„ç‰ˆæœ¬å·ï¼Œç„¶åè¯»å–æ•°æ®ï¼Œæ‰€ä»¥å¦‚æœä¸¤è€…ä¸ä¸€è‡´ï¼Œå¯èƒ½ä¼šé€ æˆè¯»å–å¼‚å¸¸çš„æƒ…å†µã€‚useMutableSource ä¼šæ£€æŸ¥ç‰ˆæœ¬å·ï¼š</p><ul><li>åœ¨ç¬¬ä¸€æ¬¡ç»„ä»¶æŒ‚è½½çš„æ—¶å€™ï¼Œè¯»å–ç‰ˆæœ¬å·ã€‚</li><li>åœ¨ç»„ä»¶ rerender çš„æ—¶å€™ï¼Œç¡®ä¿ç‰ˆæœ¬å·ä¸€è‡´ï¼Œç„¶ååœ¨è¯»å–æ•°æ®ã€‚ä¸ç„¶ä¼šé€ æˆé”™è¯¯å‘ç”Ÿã€‚</li><li>ç¡®ä¿æ•°æ®æºå’Œç‰ˆæœ¬å·çš„ä¸€è‡´æ€§ã€‚</li></ul><p><strong>è®¾è®¡è§„èŒƒ</strong></p><p>å½“é€šè¿‡ getSnapshot è¯»å–å¤–éƒ¨æ•°æ®æºçš„æ—¶å€™ï¼Œè¿”å›çš„ value åº”è¯¥æ˜¯ä¸å¯å˜çš„ã€‚</p><ul><li>âœ… æ­£ç¡®å†™æ³•ï¼šgetSnapshot: source =&gt; Array.from(source.friendIDs)</li><li>âŒ é”™è¯¯å†™æ³•ï¼šgetSnapshot: source =&gt; source.friendIDs</li></ul><p>æ•°æ®æºå¿…é¡»æœ‰ä¸€ä¸ªå…¨å±€çš„ç‰ˆæœ¬å·ï¼Œè¿™ä¸ªç‰ˆæœ¬å·ä»£è¡¨æ•´ä¸ªæ•°æ®æºï¼š</p><ul><li>âœ… æ­£ç¡®å†™æ³•ï¼šgetVersion: () =&gt; source.version</li><li>âŒ é”™è¯¯å†™æ³•ï¼šgetVersion: () =&gt; source.user.version</li></ul><p>æ¥ä¸‹æ¥å‚è€ƒ github ä¸Šçš„ä¾‹å­ï¼Œæˆ‘è®²ä¸€ä¸‹å…·ä½“æ€ä¹ˆä½¿ç”¨ï¼š</p><h4 id="ä¾‹å­ä¸€" tabindex="-1">ä¾‹å­ä¸€ â€‹</h4><p><strong>ä¾‹å­ä¸€ï¼šè®¢é˜… history æ¨¡å¼ä¸‹è·¯ç”±å˜åŒ–</strong></p><p>æ¯”å¦‚æœ‰ä¸€ä¸ªåœºæ™¯å°±æ˜¯åœ¨éäººä¸ºæƒ…å†µä¸‹ï¼Œè®¢é˜…è·¯ç”±å˜åŒ–ï¼Œå±•ç¤ºå¯¹åº”çš„ <code>location.pathname</code>ï¼Œçœ‹ä¸€ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ useMutableSource å¤„ç†çš„ã€‚åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œå¤–éƒ¨æ•°æ®æºå°±æ˜¯ location ä¿¡æ¯ã€‚</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é€šè¿‡ createMutableSource åˆ›å»ºä¸€ä¸ªå¤–éƒ¨æ•°æ®æºã€‚</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ•°æ®æºå¯¹è±¡ä¸º windowã€‚</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç”¨ location.href ä½œä¸ºæ•°æ®æºçš„ç‰ˆæœ¬å·ï¼Œhref å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆè¯´æ˜æ•°æ®æºå‘ç”Ÿå˜åŒ–ã€‚</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> locationSource</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createMutableSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  window,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> window.location.href</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è·å–å¿«ç…§ä¿¡æ¯ï¼Œè¿™é‡Œè·å–çš„æ˜¯ location.pathname å­—æ®µï¼Œè¿™ä¸ªæ˜¯å¯ä»¥å¤ç”¨çš„ï¼Œå½“è·¯ç”±å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨å¿«ç…§å‡½æ•°ï¼Œæ¥å½¢æˆæ–°çš„å¿«ç…§ä¿¡æ¯ã€‚</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getSnapshot</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> window</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> window.location.pathname</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è®¢é˜…å‡½æ•°ã€‚</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> subscribe</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">window</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">callback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   //é€šè¿‡ popstate ç›‘å¬ history æ¨¡å¼ä¸‹çš„è·¯ç”±å˜åŒ–ï¼Œè·¯ç”±å˜åŒ–çš„æ—¶å€™ï¼Œæ‰§è¡Œå¿«ç…§å‡½æ•°ï¼Œå¾—åˆ°æ–°çš„å¿«ç…§ä¿¡æ¯ã€‚</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  window.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;popstate&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, callback);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   //å–æ¶ˆç›‘å¬</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> window.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">removeEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;popstate&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, callback);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Example</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // é€šè¿‡ useMutableSourceï¼ŒæŠŠæ•°æ®æºå¯¹è±¡ï¼Œå¿«ç…§å‡½æ•°ï¼Œè®¢é˜…å‡½æ•°ä¼ å…¥ï¼Œå½¢æˆ pathNameã€‚  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> pathName</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useMutableSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(locationSource, getSnapshot, subscribe);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>æ¥æç»˜ä¸€ä¸‹æµç¨‹ï¼š</p><ul><li>é¦–å…ˆé€šè¿‡ <code>createMutableSource</code> åˆ›å»ºä¸€ä¸ªæ•°æ®æºå¯¹è±¡ï¼Œè¯¥æ•°æ®æºå¯¹è±¡ä¸º windowã€‚ ç”¨ location.href ä½œä¸ºæ•°æ®æºçš„ç‰ˆæœ¬å·ï¼Œhref å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆè¯´æ˜æ•°æ®æºå‘ç”Ÿå˜åŒ–ã€‚</li><li>è·å–å¿«ç…§ä¿¡æ¯ï¼Œè¿™é‡Œè·å–çš„æ˜¯ location.pathname å­—æ®µï¼Œè¿™ä¸ªæ˜¯å¯ä»¥å¤ç”¨çš„ï¼Œå½“è·¯ç”±å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨å¿«ç…§å‡½æ•°ï¼Œæ¥å½¢æˆæ–°çš„å¿«ç…§ä¿¡æ¯ã€‚</li><li>é€šè¿‡ <code>popstate</code> ç›‘å¬ <code>history</code> æ¨¡å¼ä¸‹çš„è·¯ç”±å˜åŒ–ï¼Œè·¯ç”±å˜åŒ–çš„æ—¶å€™ï¼Œæ‰§è¡Œå¿«ç…§å‡½æ•°ï¼Œå¾—åˆ°æ–°çš„å¿«ç…§ä¿¡æ¯ã€‚</li><li>é€šè¿‡ <code>useMutableSource</code> ï¼ŒæŠŠæ•°æ®æºå¯¹è±¡ï¼Œå¿«ç…§å‡½æ•°ï¼Œè®¢é˜…å‡½æ•°ä¼ å…¥ï¼Œå½¢æˆ <code>pathName</code> ã€‚</li></ul><p>å¯èƒ½è¿™ä¸ªä¾‹å­ğŸŒ°ï¼Œä¸è¶³ä»¥è®©ä½ æ¸…æ¥š useMutableSource çš„ä½œç”¨ï¼Œæˆ‘ä»¬å†ä¸¾ä¸€ä¸ªä¾‹å­çœ‹ä¸€ä¸‹ useMutableSource å¦‚ä½•å’Œ redux å¥‘åˆä½¿ç”¨çš„ã€‚</p><h4 id="ä¾‹å­äºŒ" tabindex="-1">ä¾‹å­äºŒ â€‹</h4><p><strong>ä¾‹å­äºŒï¼šredux ä¸­ <code>useMutableSource</code> ä½¿ç”¨</strong></p><p>redux å¯ä»¥é€šè¿‡ useMutableSource ç¼–å†™è‡ªå®šä¹‰ hooks â€”â€” <code>useSelector</code>ï¼ŒuseSelector å¯ä»¥è¯»å–æ•°æ®æºçš„çŠ¶æ€ï¼Œå½“æ•°æ®æºæ”¹å˜çš„æ—¶å€™ï¼Œé‡æ–°æ‰§è¡Œå¿«ç…§è·å–çŠ¶æ€ï¼Œåšåˆ°è®¢é˜…æ›´æ–°ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹ useSelector æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> mutableSource</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createMutableSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  reduxStore, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å°† redux çš„ store ä½œä¸ºæ•°æ®æºã€‚</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // state æ˜¯ä¸å¯å˜çš„ï¼Œå¯ä»¥ä½œä¸ºæ•°æ®æºçš„ç‰ˆæœ¬å·</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> reduxStore.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é€šè¿‡åˆ›å»º context ä¿å­˜æ•°æ®æº mutableSourceã€‚</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> MutableSourceContext</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(mutableSource);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è®¢é˜… store å˜åŒ–ã€‚store å˜åŒ–ï¼Œæ‰§è¡Œ getSnapshot</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> subscribe</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">store</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">callback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> store.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">subscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(callback);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è‡ªå®šä¹‰ hooks useSelector å¯ä»¥åœ¨æ¯ä¸€ä¸ª connect å†…éƒ¨ä½¿ç”¨ï¼Œé€šè¿‡ useContext è·å– æ•°æ®æºå¯¹è±¡ã€‚ </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">selector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> mutableSource</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(MutableSourceContext);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // ç”¨ useCallback è®© getSnapshot å˜æˆæœ‰è®°å¿†çš„ã€‚ </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> getSnapshot</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useCallback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">store</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> selector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(store.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()), [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    selector</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ]);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // æœ€åæœ¬è´¨ä¸Šç”¨çš„æ˜¯ useMutableSource è®¢é˜… state å˜åŒ–ã€‚  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useMutableSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(mutableSource, getSnapshot, subscribe);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>å¤§è‡´æµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><ul><li>å°† redux çš„ store ä½œä¸ºæ•°æ®æºå¯¹è±¡ <code>mutableSource</code> ã€‚ state æ˜¯ä¸å¯å˜çš„ï¼Œå¯ä»¥ä½œä¸ºæ•°æ®æºçš„ç‰ˆæœ¬å·ã€‚</li><li>é€šè¿‡åˆ›å»º context ä¿å­˜æ•°æ®æºå¯¹è±¡ <code>mutableSource</code>ã€‚</li><li>å£°æ˜è®¢é˜…å‡½æ•°ï¼Œè®¢é˜… store å˜åŒ–ã€‚store å˜åŒ–ï¼Œæ‰§è¡Œ <code>getSnapshot</code> ã€‚</li><li>è‡ªå®šä¹‰ hooks <code>useSelector</code> å¯ä»¥åœ¨æ¯ä¸€ä¸ª connect å†…éƒ¨ä½¿ç”¨ï¼Œé€šè¿‡ useContext è·å– æ•°æ®æºå¯¹è±¡ã€‚ ç”¨ <code>useCallback</code> è®© getSnapshot å˜æˆæœ‰è®°å¿†çš„ã€‚</li><li>æœ€åæœ¬è´¨ä¸Šç”¨çš„æ˜¯ useMutableSource è®¢é˜…å¤–éƒ¨ state å˜åŒ–ã€‚</li></ul><p><strong>æ³¨æ„é—®é¢˜</strong></p><ul><li>åœ¨åˆ›å»º getSnapshot çš„æ—¶å€™ï¼Œéœ€è¦å°† getSnapshot è®°å¿†åŒ–å¤„ç†ï¼Œå°±åƒä¸Šè¿°æµç¨‹ä¸­çš„ useCallback å¤„ç† getSnapshot ä¸€æ ·ï¼Œå¦‚æœä¸è®°å¿†å¤„ç†ï¼Œé‚£ä¹ˆä¼šè®©ç»„ä»¶é¢‘ç¹æ¸²æŸ“ã€‚</li><li>åœ¨æœ€æ–°çš„ react-redux æºç ä¸­ï¼Œå·²ç»ä½¿ç”¨æ–°çš„ apiï¼Œè®¢é˜…å¤–éƒ¨æ•°æ®æºï¼Œä¸è¿‡ä¸æ˜¯ <code>useMutableSource</code> è€Œæ˜¯ <code>useSyncExternalStore</code>ï¼Œå…·ä½“å› ä¸º <code>useMutableSource</code> æ²¡æœ‰æä¾›å†…ç½®çš„ selectorAPIï¼Œéœ€è¦æ¯ä¸€æ¬¡å½“é€‰æ‹©å™¨å˜åŒ–æ—¶å€™é‡æ–°è®¢é˜… storeï¼Œå¦‚æœæ²¡æœ‰ useCallback ç­‰ api è®°å¿†åŒ–å¤„ç†ï¼Œé‚£ä¹ˆå°†é‡æ–°è®¢é˜…ã€‚å…·ä½“å†…å®¹è¯·å‚è€ƒ useMutableSource â†’ useSyncExternalStoreã€‚</li></ul><h3 id="ä¸‰-å®è·µ" tabindex="-1">ä¸‰ å®è·µ â€‹</h3><p>æ¥ä¸‹æ¥æˆ‘ç”¨ä¸€ä¸ªä¾‹å­æ¥å…·ä½“å®è·µä¸€ä¸‹ <code>createMutableSource</code>ï¼Œè®©å¤§å®¶æ›´æ¸…æ™°æµç¨‹ã€‚</p><p>è¿™é‡Œè¿˜æ˜¯é‡‡ç”¨ redux å’Œ createMutableSource å®ç°å¤–éƒ¨æ•°æ®æºçš„å¼•ç”¨ã€‚è¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>18.0.0-alpha</code> ç‰ˆæœ¬çš„ <code>react</code> å’Œ <code>react-dom</code> ã€‚</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a000b3baac184fe9903700ad51e03be7~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="3.jpg" loading="lazy"></p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  React , {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    unstable_useMutableSource </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> useMutableSource,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    unstable_createMutableSource </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> createMutableSource</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;react&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { combineReducers , createStore  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;redux&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* number Reducer */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> numberReducer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">state</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">action</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    switch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (action.type){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;ADD&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> state </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;DEL&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> state </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> state</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* æ³¨å†Œreducer */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> rootReducer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> combineReducers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ number:numberReducer  })</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* åˆæˆStore */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Store</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createStore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(rootReducer,{ number: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  })</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* æ³¨å†Œå¤–éƒ¨æ•°æ®æº */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> dataSource</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createMutableSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">( Store ,() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> )</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* è®¢é˜…å¤–éƒ¨æ•°æ®æº */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> subscribe</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">dataSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">callback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> unSubScribe</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> dataSource.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">subscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(callback)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> unSubScribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* TODO: æƒ…å†µä¸€ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(){</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* è·å–æ•°æ®å¿«ç…§ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">     const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> shotSnop</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> React.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">useCallback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ({</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()}),[])</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /*  hooks:ä½¿ç”¨ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useMutableSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dataSource,shotSnop,subscribe)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; æ‹¥æŠ± React 18 ğŸ‰ğŸ‰ğŸ‰ &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        èµï¼š{data.number} &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">br</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">button</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> onClick</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Store.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dispatch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ type:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ADD&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> })} &gt;ç‚¹èµ&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">button</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>ç¬¬ä¸€éƒ¨åˆ†ç”¨ <code>combineReducers</code> å’Œ <code>createStore</code> åˆ›å»º redux Store çš„è¿‡ç¨‹ã€‚ é‡ç‚¹æ˜¯ç¬¬äºŒéƒ¨åˆ†ï¼š</p><ul><li>é¦–å…ˆé€šè¿‡ createMutableSource åˆ›å»ºæ•°æ®æºï¼ŒStore ä¸ºæ•°æ®æºï¼Œ<code>data.getState()</code> ä½œä¸ºç‰ˆæœ¬å·ã€‚</li><li>ç¬¬äºŒç‚¹å°±æ˜¯å¿«ç…§ä¿¡æ¯ï¼Œè¿™é‡Œçš„å¿«ç…§å°±æ˜¯ store ä¸­çš„ stateã€‚æ‰€ä»¥åœ¨ <code>shotSnop</code> è¿˜æ˜¯é€šè¿‡ getState è·å–çŠ¶æ€ï¼Œæ­£å¸¸æƒ…å†µä¸‹ shotSnop åº”è¯¥ä½œä¸º <code>Selector</code>ï¼Œè¿™é‡ŒæŠŠæ‰€æœ‰çš„ state éƒ½æ˜ å°„å‡ºæ¥äº†ã€‚</li><li>ç¬¬ä¸‰å°±æ˜¯é€šè¿‡ <code>useMutableSource</code> æŠŠæ•°æ®æºï¼Œå¿«ç…§ï¼Œè®¢é˜…å‡½æ•°ä¼ å…¥ï¼Œå¾—åˆ°çš„ data å°±æ˜¯å¼•ç”¨çš„å¤–éƒ¨æ•°æ®æºäº†ã€‚</li></ul><p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹æ•ˆæœï¼š</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/81ad31834d0941859cf767d22d685c6b~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="4.gif" loading="lazy"></p><h3 id="å››-åŸç†åˆ†æ" tabindex="-1">å›› åŸç†åˆ†æ â€‹</h3><p>useMutableSource å·²ç»åœ¨ React v18 çš„è§„åˆ’ä¹‹ä¸­äº†ï¼Œé‚£ä¹ˆå®ƒçš„å®ç°åŸç†ä»¥åŠç»†èŠ‚ï¼Œåœ¨ V18 æ­£å¼æ¨å‡ºä¹‹å‰å¯ä»¥è¿˜ä¼šæœ‰è°ƒæ•´ï¼Œ</p><h4 id="_1-createmutablesource" tabindex="-1">1 createMutableSource â€‹</h4><blockquote><p>react/src/ReactMutableSource.js -&gt; createMutableSource</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createMutableSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">source</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">getVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> mutableSource</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        _getVersion: getVersion,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        _source: source,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        _workInProgressVersionPrimary: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        _workInProgressVersionSecondary: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    };</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mutableSource</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>createMutableSource çš„åŸç†éå¸¸ç®€å•ï¼Œå’Œ <code>createContext</code> ï¼Œ <code>createRef</code> ç±»ä¼¼ï¼Œ å°±æ˜¯åˆ›å»ºä¸€ä¸ª <code>createMutableSource</code> å¯¹è±¡ï¼Œ</p><h4 id="_2-usemutablesource" tabindex="-1">2 useMutableSource â€‹</h4><p>å¯¹äº useMutableSource åŸç†ä¹Ÿæ²¡æœ‰é‚£ä¹ˆç„ä¹ï¼ŒåŸæ¥æ˜¯ç”±å¼€å‘è€…è‡ªå·±æŠŠå¤–éƒ¨æ•°æ®æºæ³¨å…¥åˆ° state ä¸­ï¼Œç„¶åå†™è®¢é˜…å‡½æ•°ã€‚ useMutableSource çš„åŸç†å°±æ˜¯æŠŠå¼€å‘è€…è¯¥åšçš„äº‹ï¼Œè‡ªå·±åšäº†ğŸ˜‚ğŸ˜‚ğŸ˜‚ï¼Œè¿™æ ·çœç€å¼€å‘è€…å»å†™ç›¸å…³çš„ä»£ç äº†ã€‚æœ¬è´¨ä¸Šå°±æ˜¯ <strong>useState + useEffect</strong> ï¼š</p><ul><li>useState è´Ÿè´£æ›´æ–°ã€‚</li><li>useEffect è´Ÿè´£è®¢é˜…ã€‚</li></ul><p>ç„¶åæ¥çœ‹ä¸€ä¸‹åŸç†ã€‚</p><blockquote><p>react-reconciler/src/ReactFiberHooks.new.js -&gt; useMutableSource</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useMutableSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">hook</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">source</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">getSnapshot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">){</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* è·å–ç‰ˆæœ¬å· */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> getVersion</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> source._getVersion;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(source._source);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* ç”¨ useState ä¿å­˜å½“å‰ Snapshotï¼Œè§¦å‘æ›´æ–°ã€‚ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [currentSnapshot, setSnapshot] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> dispatcher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">useState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">       readFromUnsubscribedMutableSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(root, source, getSnapshot),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    dispatcher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">useEffect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* åŒ…è£…å‡½æ•°  */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handleChange</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            /* è§¦å‘æ›´æ–° */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            setSnapshot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* è®¢é˜…æ›´æ–° */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> unsubscribe</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> subscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(source._source, handleChange);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* å–æ¶ˆè®¢é˜… */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> unsubscribe;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },[source, subscribe])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>ä¸Šè¿°ä»£ç ä¸­ä¿ç•™äº†æœ€æ ¸å¿ƒçš„é€»è¾‘ï¼š</p><ul><li>é¦–å…ˆé€šè¿‡ <code>getVersion</code> è·å–æ•°æ®æºç‰ˆæœ¬å·ï¼Œç”¨ <code>useState</code> ä¿å­˜å½“å‰ Snapshotï¼ŒsetSnapshot ç”¨äºè§¦å‘æ›´æ–°ã€‚</li><li>åœ¨ <code>useEffect</code> ä¸­ï¼Œè¿›è¡Œè®¢é˜…ï¼Œç»‘å®šçš„æ˜¯åŒ…è£…å¥½çš„ handleChange å‡½æ•°ï¼Œé‡Œé¢è°ƒç”¨ setSnapshot çœŸæ­£çš„æ›´æ–°ç»„ä»¶ã€‚</li><li>æ‰€ä»¥ useMutableSource æœ¬è´¨ä¸Šè¿˜æ˜¯ useState ã€‚</li></ul><h3 id="äº”-æ€»ç»“" tabindex="-1">äº” æ€»ç»“ â€‹</h3><p>ä»Šå¤©è®²äº† useMutableSource çš„èƒŒæ™¯ï¼Œç”¨æ³•ï¼Œä»¥åŠåŸç†ã€‚å¸Œæœ›é˜…è¯»çš„åŒå­¦å¯ä»¥å…‹éš†ä¸€ä¸‹ React v18 çš„æ–°ç‰ˆæœ¬ï¼Œå°è¯•ä¸€ä¸‹æ–°ç‰¹æ€§ï¼Œå°†å¯¹ç†è§£ useMutableSource å¾ˆæœ‰å¸®åŠ©ã€‚ä¸‹ä¸€ç« æˆ‘ä»¬å°†ç»§ç»­å›´ç»• React v18 å±•å¼€ã€‚</p>`,88),l=[e];function h(p,k,r,d,E,c){return a(),i("div",null,l)}const b=s(t,[["render",h]]);export{F as __pageData,b as default};
