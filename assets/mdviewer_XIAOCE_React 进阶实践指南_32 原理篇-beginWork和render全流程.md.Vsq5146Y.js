import{_ as s}from"./app.BdTF1atn.js";import{j as i,i as a,Z as n}from"./chunks/@vue.D6nrJjhM.js";/* empty css                          */import"./chunks/@vueuse.ErXst1iV.js";const u=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"mdviewer/XIAOCE/React è¿›é˜¶å®è·µæŒ‡å—/32 åŸç†ç¯‡-beginWorkå’Œrenderå…¨æµç¨‹.md","filePath":"mdviewer/XIAOCE/React è¿›é˜¶å®è·µæŒ‡å—/32 åŸç†ç¯‡-beginWorkå’Œrenderå…¨æµç¨‹.md"}'),e={name:"mdviewer/XIAOCE/React è¿›é˜¶å®è·µæŒ‡å—/32 åŸç†ç¯‡-beginWorkå’Œrenderå…¨æµç¨‹.md"},p=n(`<h2 id="è¿‡æ—¶çš„-react-api" tabindex="-1">è¿‡æ—¶çš„ React API â€‹</h2><h3 id="ä¸€-å‰è¨€" tabindex="-1">ä¸€ å‰è¨€ â€‹</h3><p>åœ¨ fiber ç« èŠ‚ä»‹ç»è¿‡ï¼Œå½“ç»„ä»¶æ›´æ–°ï¼Œæœ¬è´¨ä¸Šæ˜¯ä» fiberRoot å¼€å§‹æ·±åº¦è°ƒå’Œ fiber æ ‘ã€‚é‚£ä¹ˆæœ¬ç« èŠ‚å°†ç»§ç»­å›´ç»• React è°ƒå’Œæµç¨‹ã€‚ä»‹ç»ä¸€ä¸‹è°ƒå’Œæµç¨‹ï¼Œé¦–å…ˆæ€è€ƒå‡ ä¸ªé—®é¢˜ï¼š</p><ul><li>ç»„ä»¶ A è§¦å‘ <code>setState</code> æˆ–è€… <code>useState</code> æ›´æ–°è§†å›¾ï¼Œæ—¢ç„¶ <code>fiber</code> æ˜¯ä» root å¼€å§‹æ›´æ–°ï¼Œé‚£ä¹ˆå¦‚ä½•æ‰¾åˆ°å¯¹åº”çš„ A å¹¶ rerender çš„å‘¢ï¼Ÿ</li><li>ç»„ä»¶ç±»å‹ fiber è¿›è¡Œ <code>beginWork</code> å°±ä¸€å®šä¼šè¿›è¡Œ <code>render</code> å—ï¼Ÿ</li></ul><h3 id="äºŒ-state-æ›´æ–°æºæ³‰" tabindex="-1">äºŒ state æ›´æ–°æºæ³‰ â€‹</h3><h4 id="_1-æ›´æ–°çš„æœ€å°å•å…ƒ" tabindex="-1">1 æ›´æ–°çš„æœ€å°å•å…ƒ â€‹</h4><p>è™½ç„¶åœ¨ ReactV18 å¼•å…¥è®¢é˜…å¤–éƒ¨æ•°æ®æºçš„ <code>useMutableSource</code>ã€‚ä½†åœ¨å½“å‰ç‰ˆæœ¬çš„ React ä¸­ï¼Œè§†å›¾çš„æ›´æ–°åŸºæœ¬éƒ½æ¥æºäºå†…éƒ¨ state çš„æ”¹å˜ã€‚å¦‚æœæœ‰ä¸€ä¸ªç»„ä»¶ A ï¼Œå¦‚æœæƒ³è¦å®ƒæ›´æ–°ï¼Œé‚£ä¹ˆåœºæ™¯æœ‰å¦‚ä¸‹æƒ…å†µï¼š</p><ul><li>ç»„ä»¶æœ¬èº«æ”¹å˜ <code>state</code> ã€‚å‡½æ•° <code>useState</code> | <code>useReducer</code> ï¼Œç±»ç»„ä»¶ <code>setState</code> | <code>forceUpdate</code>ã€‚</li><li><code>props</code> æ”¹å˜ï¼Œç”±ç»„ä»¶æ›´æ–°å¸¦æ¥çš„å­ç»„ä»¶çš„æ›´æ–°ã€‚</li><li><code>context</code>æ›´æ–°ï¼Œå¹¶ä¸”è¯¥ç»„ä»¶æ¶ˆè´¹äº†å½“å‰ <code>context</code> ã€‚</li></ul><p>æ— è®ºæ˜¯ä¸Šé¢å“ªç§æ–¹å¼ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯ state çš„å˜åŒ–ã€‚</p><ul><li>props æ”¹å˜æ¥æºäºçˆ¶çº§ç»„ä»¶çš„ state å˜åŒ–ã€‚</li><li>context å˜åŒ–æ¥æºäº <code>Provider</code> ä¸­ value å˜åŒ–ï¼Œè€Œ value ä¸€èˆ¬æƒ…å†µä¸‹ä¹Ÿæ˜¯ state æˆ–è€…æ˜¯ state è¡ç”Ÿäº§ç‰©ã€‚</li></ul><p><code>state</code> æ”¹å˜æ˜¯åœ¨ç»„ä»¶å¯¹åº”çš„ fiber å•ä½ä¸Šçš„ï¼Œä¹‹å‰çš„ fiber ç« èŠ‚è®²åˆ°äº†åœ¨ React çš„ä¸–ç•Œé‡Œä¼šå­˜åœ¨å¤šç§å¤šæ ·çš„ fiber ç±»å‹ï¼Œ è€Œå¼€å‘è€…å¹³æ—¶ä½¿ç”¨çš„ç»„ä»¶ <code>function Component</code> æˆ–è€… <code>Class Component</code> ä¹Ÿæ˜¯ä¸¤ç§ä¸åŒçš„ fiber ç±»å‹ã€‚è€Œä¸” React åº•å±‚å¯¹å®ƒä»¬çš„å¤„ç†é€»è¾‘ä¹Ÿä¸ç›¸åŒã€‚</p><ul><li>æ¯”å¦‚æ›´æ–°ç±»ç»„ä»¶ç”¨çš„æ˜¯ <code>updateClassComponent</code>ï¼Œå®ƒåšçš„äº‹æƒ…æ˜¯åˆå§‹åŒ–æ—¶å€™å®ä¾‹åŒ–ç±»ç»„ä»¶ï¼Œæ›´æ–°çš„è¯é‚£ä¹ˆç›´æ¥è°ƒç”¨ render å¾—åˆ°æ–°çš„ <code>children</code> ï¼›</li><li>æ›´æ–°å‡½æ•°ç»„ä»¶ç”¨çš„æ˜¯ <code>updateFunctionComponent</code>ï¼Œé‡Œé¢è°ƒç”¨ <code>renderWithHooks</code> æ‰§è¡Œå‡½æ•°ç»„ä»¶å¹¶ä¾æ¬¡è°ƒç”¨ <code>hooks</code>ã€‚è¿™é‡Œç»†èŠ‚é—®é¢˜ä¸éœ€è¦æ‹˜æ³¥ã€‚</li></ul><p>é‚£ä¹ˆåœ¨æ•´ä¸ª <code>React</code> ç³»ç»Ÿä¸­ï¼Œèƒ½å¤Ÿæ›´æ–° state çš„åŸºæœ¬éƒ½åœ¨ç»„ä»¶å±‚é¢ä¸Šï¼Œæ¢å¥è¯è¯´åªæœ‰ç»„ä»¶æ‰èƒ½å‡ºå‘æ›´æ–°ï¼Œæ¯”å¦‚ <code>div</code> å…ƒç´  hostComponent ç±»å‹çš„ fiberï¼Œå®ƒæ˜¯æ— æ³•ç‹¬ç«‹çš„è‡ªæˆ‘æ›´æ–°çš„ï¼Œåªèƒ½ä¾èµ–äºçˆ¶ç±»çš„ç»„ä»¶æ›´æ–° state ï¼Œä½†æ˜¯åœ¨è°ƒå’Œé˜¶æ®µï¼Œå®ƒä¹Ÿä¼šä½œä¸ºä¸€ä¸ªä»»åŠ¡å•å…ƒè¿›å…¥åˆ° workLoop ä¸­ ï¼›ç»¼ä¸Šæ‰€è¿°ï¼Œå¯ä»¥è¿™ä¹ˆç†è§£</p><ul><li><p><strong>fiberæ˜¯è°ƒå’Œè¿‡ç¨‹ä¸­çš„æœ€å°å•å…ƒï¼Œæ¯ä¸€ä¸ªéœ€è¦è°ƒå’Œçš„ fiber éƒ½ä¼šè¿›å…¥ workLoop ä¸­</strong>ã€‚</p></li><li><p><strong>è€Œç»„ä»¶æ˜¯æœ€å°çš„æ›´æ–°å•å…ƒï¼ŒReact çš„æ›´æ–°æºäºæ•°æ®å±‚ state çš„å˜åŒ–</strong>ã€‚</p></li></ul><h4 id="_2-beginwork-æ›´æ–°æºæ³‰" tabindex="-1">2 beginWork æ›´æ–°æºæ³‰ â€‹</h4><p>é‚£ä¹ˆæˆ‘ä»¬ä»Šå¤©çš„ä¸»è§’å°±æ˜¯ç»„ä»¶ç±»å‹çš„ fiber ã€‚æ·±å…¥ç ”ç©¶ä¸€ä¸‹ç»„ä»¶ç±»å‹çš„ fiber è°ƒå’Œæµç¨‹ã€‚ç±»ç»„ä»¶åœ¨ render é˜¶æ®µçš„ä¸€ä¸ªé‡è¦ä½œç”¨å°±æ˜¯äº§ç”Ÿæ–°çš„ children ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ <code>rerender</code>ã€‚åªæœ‰äº§ç”Ÿæ–°çš„ children ï¼Œæ¥ä¸‹æ¥æ‰èƒ½æ·±åº¦éå† children ï¼Œæ”¹å˜è§†å›¾ã€‚æ¯ä¸€ä¸ªéœ€è¦è°ƒå’Œçš„ fiber éƒ½è¦ç»å†ä¸€ä¸ªè¿‡ç¨‹å«åš <code>beginWork</code> ï¼Œåœ¨ beginWork æµç¨‹ä¸­å°†æ‰§è¡Œä¸Šè¿°å„ç§ fiber çš„æ›´æ–°å‡½æ•°ã€‚</p><p>é‚£ä¹ˆå¯¹äºç»„ä»¶ç±»å‹ fiber è¯´ï¼Œè¿›å…¥åˆ° workLoop ä¸­ï¼Œé‚£ä¹ˆä¸€å®šä¼š <code>rerender</code> å—ï¼Ÿ ç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œè§£ææ¥çœ‹å‡ ç§æƒ…å†µã€‚</p><p>ä¸»è¦çœ‹ä¸€ä¸‹å¦‚ä¸‹ demo ï¼š</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* å­ç»„ä»¶2 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Child2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;å­ç»„ä»¶ 2&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* å­ç»„ä»¶1 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Child1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">num</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> , </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">setNumber</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> React.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">useState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        å­ç»„ä»¶ {num}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">button</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> onClick</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> setNumber</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(num</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)} &gt;æŒ‰é’®1&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">button</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">     &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* çˆ¶ç»„ä»¶ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">num</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> , </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">setNumber</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> React.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">useState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;çˆ¶ç»„ä»¶ {num} &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Child1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Child2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">button</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> onClick</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> setNumber</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(num</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)} &gt;æŒ‰é’®2&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">button</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>åœºæ™¯ä¸€</strong>ï¼šå¦‚ä¸Š demo ä¸­ï¼Œå½“ç‚¹å‡» <code>Child1</code> çš„ æŒ‰é’®1 çš„æ—¶å€™ï¼ŒChild1 ä¼šæ¸²æŸ“ï¼Œé‚£ä¹ˆ Child1 è‡ªç„¶ä¼šè¿›å…¥åˆ° <code>beginWork</code> æµç¨‹ä¸­ï¼Œé‚£ä¹ˆç–‘é—®æ¥äº†ï¼š</p><ul><li>é—®é¢˜ä¸€ï¼šçˆ¶ç»„ä»¶ <code>Index</code> æ²¡æœ‰æ›´æ–°ï¼Œä¼š rerender å—ï¼Ÿé‚£ä¹ˆæœ‰ä¼šè¿›å…¥ <code>beginWork</code> æµç¨‹å— ï¼Ÿ</li><li>é—®é¢˜äºŒï¼š<code>Child2</code> ä¼šè¿›å…¥ <code>beginWork</code>æµç¨‹å— ï¼Ÿ</li><li>é—®é¢˜ä¸‰ï¼šå¦‚æœ <code>Index</code> ä¼š <code>beginWork</code>ï¼Œé‚£ä¹ˆ React ä» Root fiber å¼€å§‹è°ƒå’Œçš„æ—¶å€™ï¼Œæ˜¯å¦‚ä½•æ‰¾åˆ°æ›´æ–°çš„äº‹å‘ç‚¹ Index çš„å‘¢ï¼Ÿ</li></ul><p><strong>åœºæ™¯äºŒ</strong>ï¼šåœ¨å¦‚ä¸Š demo ä¸­ï¼Œå½“ç‚¹å‡» Index ä¸­çš„ <strong>æŒ‰é’®2</strong> çš„æ—¶å€™ï¼š</p><ul><li>é—®é¢˜å››ï¼š<code>Index</code> å› ä¸ºæœ¬èº«çš„ <code>state</code> æ”¹å˜ä¼šæ›´æ–°ï¼Œé‚£ä¹ˆ <code>Child1</code> å’Œ <code>Child2</code> ä¸ºä»€ä¹ˆä¼šè·Ÿç€æ›´æ–°ã€‚</li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹ä»¥ä¸€æ¬¡æ›´æ–°å¼€å§‹ï¼Œåˆ†æè°ƒå’Œè¿‡ç¨‹ä¸­ beginWork æµç¨‹ã€‚</p><p>åœ¨æ­£å¼æµç¨‹åˆ†æä¹‹å‰ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹ v17 å¼•å‡ºçš„æ–°çš„æ¦‚å¿µï¼Œåœ¨ v16 ç‰ˆæœ¬ï¼Œä»»åŠ¡çš„ä¼˜å…ˆçº§ç”¨ expirationTime è¡¨ç¤ºï¼Œåœ¨ v17 ç‰ˆæœ¬è¢« lane å–ç¼”ã€‚</p><ul><li><strong>lane</strong> ï¼š æ›´æ–°ä¼˜å…ˆçº§ã€‚ï¼ˆåœ¨ä¸€æ¬¡æ›´æ–°ä»»åŠ¡ä¸­ï¼Œå°†èµ‹äºˆç»™æ›´æ–°çš„ fiber çš„ä¸€ä¸ªæ›´æ–°ä¼˜å…ˆçº§ laneã€‚ï¼‰</li><li><strong>childLanes</strong>ï¼š<code>children</code> ä¸­æ›´æ–°ä¼˜å…ˆçº§ã€‚ï¼ˆå¦‚æœå½“å‰ fiber çš„ child ä¸­æœ‰é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œé‚£ä¹ˆå½“å‰ fiber çš„ childLanes ç­‰äºå½“å‰ä¼˜å…ˆçº§ï¼‰ã€‚</li></ul><p>è®°ä½è¿™ä¸¤ä¸ªæ¦‚å¿µå¯¹äºä¸‹é¢æµç¨‹åˆ†æå¾ˆæœ‰å¸®åŠ©ã€‚æ¥ä¸‹æ¥å¸¦ç€ä¸Šé¢çš„å››ä¸ªé—®é¢˜ï¼Œå¼€å§‹å¾€ä¸‹åˆ†æã€‚</p><h3 id="ä¸‰-èµ·æº-ä»-state-æ”¹å˜åˆ°-scheduleupdateonfiber" tabindex="-1">ä¸‰ èµ·æº: ä» state æ”¹å˜åˆ° scheduleUpdateOnFiber â€‹</h3><p>ä¸‹é¢ä»¥å‰é¢çš„ç‚¹å‡»æŒ‰é’®è§¦å‘ä¸€æ¬¡æ›´æ–°ä¸ºä¾‹å­ğŸŒ°ï¼Œæ·±å…¥æ¢è®¨ä¸€ä¸‹æ›´æ–°çš„å§‹æœ«æºå¤´ã€‚é¦–å…ˆä¸Šè¿°è®²åˆ°è¿‡æ›´æ–°æ˜¯ä»¥ç»„ä»¶ä¸ºç²’åº¦ï¼Œé‚£ä¹ˆè°ƒç”¨ <code>useState</code> æˆ–è€…æ˜¯ <code>setState</code> æ¥ä¸‹æ¥ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ</p><p><strong>ç±»ç»„ä»¶ setState æ›´æ–°</strong></p><blockquote><p>react-reconciler/src/ReactFiberClassComponent.new.js -&gt; classComponentUpdater</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">enqueueSetState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(inst, payload, callback){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">     const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fiber</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(inst);       </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">     const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> lane</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> requestUpdateLane</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fiber);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     scheduleUpdateOnFiber</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fiber, lane, eventTime);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>å‡½æ•°ç»„ä»¶ useState æ›´æ–°</strong></p><blockquote><p>react-reconciler/src/ReactFiberHooks.new.js -&gt; dispatchReducerAction</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> dispatchReducerAction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">fiber</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">queue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">action</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> lane</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> requestUpdateLane</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fiber);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    scheduleUpdateOnFiber</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fiber, lane, eventTime);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>å¦‚ä¸Šä»£ç éƒ½æ˜¯ç²¾ç®€åï¼Œä¿ç•™çš„æœ€æ ¸å¿ƒçš„æµç¨‹ã€‚å¯ä»¥æ˜ç¡®çœ‹åˆ°ï¼Œæ— è®ºæ˜¯ç»„ä»¶æ›´æ–°çš„æœ¬è´¨å°±æ˜¯ï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ªä»»åŠ¡ä¼˜å…ˆçº§ laneã€‚</li><li>ç„¶åè¿›è¡Œ <strong>scheduleUpdateOnFiber</strong>ã€‚ é‚£ä¹ˆè¿™ä¸ª scheduleUpdateOnFiber åº”è¯¥å°±æ˜¯æ•´ä¸ª React æ›´æ–°ä»»åŠ¡çš„å¼€å§‹ã€‚é‚£ä¹ˆè¿™ä¸ªå‡½æ•°åˆ°åº•åšäº†äº›ä»€ä¹ˆå‘¢ ï¼Ÿ</li></ul><h4 id="_1-scheduleupdateonfiber-å¼€å§‹æ›´æ–°-fiber" tabindex="-1">1 scheduleUpdateOnFiber å¼€å§‹æ›´æ–° fiber â€‹</h4><blockquote><p>react-reconciler/src/ReactFiberWorkLoop.new.js -&gt; scheduleUpdateOnFiber</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> scheduleUpdateOnFiber</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">fiber</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">lane</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">){</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* é€’å½’å‘ä¸Šæ ‡è®°æ›´æ–°ä¼˜å…ˆçº§ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> root</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> markUpdateLaneFromFiberToRoot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fiber, lane);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(root </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* å¦‚æœå½“å‰ root ç¡®å®šæ›´æ–°ï¼Œé‚£ä¹ˆä¼šæ‰§è¡Œ ensureRootIsScheduled */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ensureRootIsScheduled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(root, eventTime);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>scheduleUpdateOnFiber ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š</p><ul><li>ç¬¬ä¸€ä¸ªå°±æ˜¯é€šè¿‡å½“å‰çš„æ›´æ–°ä¼˜å…ˆçº§ lane ï¼ŒæŠŠå½“å‰ fiber åˆ° rootFiber çš„çˆ¶çº§é“¾è¡¨ä¸Šçš„æ‰€æœ‰ä¼˜å…ˆçº§éƒ½ç»™æ›´æ–°äº†ã€‚</li><li>å¦‚æœå½“å‰ fiber ç¡®å®šæ›´æ–°ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨ ensureRootIsScheduled</li></ul><p><strong>é‚£ä¹ˆ markUpdateLaneFromFiberToRoot å¦‚ä½•æ ‡è®°çš„ä¼˜å…ˆçº§ï¼Ÿ è¿™ä¸ªå¾ˆé‡è¦ï¼</strong></p><blockquote><p>react-reconciler/src/ReactFiberWorkLoop.new.js -&gt; markUpdateLaneFromFiberToRoot</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> {*}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sourceFiber</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> å‘ç”Ÿ state å˜åŒ–çš„fiber ï¼Œæ¯”å¦‚ç»„ä»¶ A è§¦å‘äº† useState ï¼Œé‚£ä¹ˆç»„ä»¶ A å¯¹åº”çš„ fiber å°±æ˜¯ sourceFiber</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> {*}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lane</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        äº§ç”Ÿçš„æ›´æ–°ä¼˜å…ˆçº§</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> markUpdateLaneFromFiberToRoot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sourceFiber</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">lane</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">){</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* æ›´æ–°å½“å‰ fiber ä¸Š */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    sourceFiber.lanes </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> mergeLanes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sourceFiber.lanes, lane);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* æ›´æ–°ç¼“å­˜æ ‘ä¸Šçš„ lanes */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> alternate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sourceFiber.alternate;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (alternate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) alternate.lanes </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> mergeLanes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(alternate.lanes, lane);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* å½“å‰æ›´æ–°çš„ fiber */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> node </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sourceFiber;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* æ‰¾åˆ°è¿”å›çˆ¶çº§ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> parent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sourceFiber.return;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(parent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">){</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* TODO: æ›´æ–° childLanes å­—æ®µ */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        parent.childLanes </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> mergeLanes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(parent.childLanes, lane);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (alternate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {  alternate.childLanes </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> mergeLanes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(alternate.childLanes, lane); }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* é€’å½’éå†æ›´æ–° */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        node </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> parent;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        parent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> parent.return;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>markUpdateLaneFromFiberToRoot åšçš„äº‹å¾ˆé‡è¦ã€‚</p><ul><li>é¦–å…ˆä¼šæ›´æ–°å½“å‰ fiber ä¸Šçš„æ›´æ–°ä¼˜å…ˆçº§ã€‚åœ¨ fiber ç« èŠ‚æˆ‘ä»¬è®²è¿‡ï¼Œfiber æ¶æ„é‡‡ç”¨ â€˜è¿ä½“å©´â€™å½¢å¼çš„åŒç¼“å†²æ ‘ï¼Œæ‰€æœ‰è¿˜è¦æ›´æ–°å½“å‰ fiber çš„ç¼“å†²æ ‘ <code>alternate</code> ä¸Šçš„ä¼˜å…ˆçº§ã€‚</li><li>ç„¶åä¼šé€’å½’å‘ä¸ŠæŠŠçˆ¶çº§è¿ä¸Šçš„ childLanes éƒ½æ›´æ–°ï¼Œæ›´æ–°æˆå½“å‰çš„ä»»åŠ¡ä¼˜å…ˆçº§ã€‚</li></ul><p>é‡ç‚¹æƒ³ä¸€æƒ³ä¸ºä»€ä¹ˆå‘ä¸Šé€’å½’æ›´æ–°çˆ¶çº§çš„ childLanes ï¼Ÿ</p><ul><li>é¦–å…ˆé€šè¿‡ fiber ç« èŠ‚æˆ‘ä»¬çŸ¥é“ï¼Œæ‰€æœ‰çš„ fiber æ˜¯é€šè¿‡ä¸€é¢— fiber æ ‘å…³è”åˆ°ä¸€èµ·çš„ï¼Œå¦‚æœç»„ä»¶ A å‘ç”Ÿä¸€æ¬¡æ›´æ–°ï¼ŒReact æ˜¯ä» root å¼€å§‹æ·±åº¦éå†æ›´æ–° fiber æ ‘ã€‚</li><li>é‚£ä¹ˆæ›´æ–°è¿‡ç¨‹ä¸­éœ€è¦æ·±åº¦éå†æ•´ä¸ª fiber æ ‘å—ï¼Ÿï¼Œå½“ç„¶ä¹Ÿä¸æ˜¯ï¼Œé‚£ä¹ˆåªæœ‰ä¸€ä¸ªç»„ä»¶æ›´æ–°ï¼Œæ‰€æœ‰çš„ fiber èŠ‚ç‚¹éƒ½è°ƒå’Œæ— ç–‘æ˜¯æ€§èƒ½ä¸Šçš„æµªè´¹ã€‚</li><li>æ—¢ç„¶è¦ä»å¤´æ›´æ–°ï¼Œåˆä¸æƒ³è°ƒå’Œæ•´ä¸ª fiber æ ‘ï¼Œé‚£ä¹ˆå¦‚ä½•æ‰¾åˆ°æ›´æ–°çš„ç»„ä»¶ A å‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™ <code>childLanes</code> å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œå¦‚æœ A å‘ç”Ÿäº†æ›´æ–°ï¼Œé‚£ä¹ˆå…ˆå‘ä¸Šé€’å½’æ›´æ–°çˆ¶çº§é“¾çš„ <code>childLanes</code>ï¼Œæ¥ä¸‹æ¥ä» Root Fiber å‘ä¸‹è°ƒå’Œçš„æ—¶å€™ï¼Œå‘ç° childLanes ç­‰äºå½“å‰æ›´æ–°ä¼˜å…ˆçº§ï¼Œé‚£ä¹ˆè¯´æ˜å®ƒçš„ child é“¾ä¸Šæœ‰æ–°çš„æ›´æ–°ä»»åŠ¡ï¼Œåˆ™ä¼šç»§ç»­å‘ä¸‹è°ƒå’Œï¼Œåä¹‹é€€å‡ºè°ƒå’Œæµç¨‹ã€‚</li></ul><p>è¿™æ ·å°±è§£å†³äº†ä¸Šé¢é—®é¢˜3 <code>å¦‚æœ</code> Index <code>ä¼š</code> beginWorkï¼Œ<code>é‚£ä¹ˆ React ä» Root fiber å¼€å§‹è°ƒå’Œçš„æ—¶å€™ï¼Œæ˜¯å¦‚ä½•æ‰¾åˆ°æ›´æ–°çš„äº‹å‘ç‚¹ Index çš„å‘¢ï¼Ÿ</code>ï¼Œ<strong>Root Fiber æ˜¯é€šè¿‡ childLanes é€æ¸å‘ä¸‹è°ƒå’Œæ‰¾åˆ°éœ€è¦æ›´æ–°çš„ç»„ä»¶çš„</strong>ã€‚</p><p>ä¸ºäº†æ›´æ¸…æ™°çš„äº†è§£æµç¨‹è¿™é‡Œç”»äº†ä¸€ä¸ªæµç¨‹å›¾ã€‚å¦‚ä¸‹ï¼š</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2421bbf350134d438f1bdc12b2882974~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="1.jpg" loading="lazy"></p><p>ä¸Šé¢æè¿°äº†æ•´ä¸ª fiber æ ‘è°ƒå’Œæµç¨‹ã€‚</p><ul><li>ç¬¬ä¸€é˜¶æ®µæ˜¯å‘ç”Ÿæ›´æ–°ï¼Œé‚£ä¹ˆäº§ç”Ÿä¸€ä¸ªæ›´æ–°ä¼˜å…ˆçº§ <code>lane</code> ã€‚</li><li>ç¬¬äºŒé˜¶æ®µå‘ä¸Šæ ‡è®° childLanes è¿‡ç¨‹ã€‚</li><li>ç¬¬ä¸‰é˜¶æ®µæ˜¯å‘ä¸‹è°ƒå’Œè¿‡ç¨‹ï¼Œæœ‰çš„åŒå­¦ä¼šé—®ï¼Œä¸ºä»€ä¹ˆ A ä¼šè¢«è°ƒå’Œï¼ŒåŸå› æ˜¯ A å’Œ B æ˜¯åŒçº§ï¼Œå¦‚æœçˆ¶çº§å…ƒç´ è°ƒå’Œï¼Œå¹¶ä¸”å‘ä¸‹è°ƒå’Œï¼Œé‚£ä¹ˆçˆ¶çº§çš„ç¬¬ä¸€çº§å­é“¾ä¸Šçš„ fiber éƒ½ä¼šè¿›å…¥è°ƒå’Œæµç¨‹ã€‚ä» fiber å…³ç³»ä¸Šçœ‹ï¼ŒRoot å…ˆè°ƒå’Œçš„æ˜¯ child æŒ‡é’ˆä¸Šçš„ A ï¼Œç„¶å A ä¼šé€€å‡ºå‘ä¸‹è°ƒå’Œï¼Œæ¥ä¸‹æ¥æ‰æ˜¯ sibling Bï¼Œæ¥ä¸‹æ¥ B ä¼šå‘ä¸‹è°ƒå’Œï¼Œé€šè¿‡ childLanes æ‰¾åˆ°å½“äº‹äºº Fï¼Œç„¶å F ä¼šè§¦å‘ render æ›´æ–°ã€‚è¿™ä¹Ÿå°±è§£å†³é—®é¢˜2ï¼ŒChild2 çš„è°ƒå’Œé—®é¢˜ã€‚</li></ul><p>é€šè¿‡ä¸Šè¿°æˆ‘ä»¬çŸ¥é“äº†å¦‚ä½•æ‰¾åˆ° F å¹¶æ‰§è¡Œ render çš„ï¼Œé‚£ä¹ˆè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ Bï¼ŒE ä¼šå‘ä¸‹è°ƒå’Œï¼Œå¦‚æœå®ƒä»¬æ˜¯ç»„ä»¶ï¼Œé‚£ä¹ˆä¼š render ä¹ˆï¼Œç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œè¦è®°ä½çš„æ˜¯è°ƒå’Œè¿‡ç¨‹å¹¶é render è¿‡ç¨‹ï¼Œ<strong>è°ƒå’Œè¿‡ç¨‹æœ‰å¯èƒ½ä¼šè§¦å‘ render å‡½æ•°</strong>ï¼Œä¹Ÿæœ‰å¯èƒ½åªæ˜¯ç»§ç»­å‘ä¸‹è°ƒå’Œï¼Œè€Œæœ¬èº«ä¸ä¼šæ‰§è¡Œ render ã€‚è¿™å°±è§£é‡Šäº†ä¸Šè¿°çš„é—®é¢˜1ã€‚</p><p>æ—¢ç„¶çŸ¥é“äº†å¦‚ä½•å»æ›´æ–° childLanes ï¼Œä»¥åŠæ›´æ–° childLanes çš„æ„ä¹‰ï¼Œæˆ‘ä»¬æ¥ç€å‘ä¸‹åˆ†ææµç¨‹ã€‚åœ¨ scheduleUpdateOnFiber ä¸­ï¼Œæœ€åä¼šè°ƒç”¨ <code>ensureRootIsScheduled</code> ï¼Œé‚£ä¹ˆå®ƒçš„ä½œç”¨åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>ç”±äº ensureRootIsScheduled æºç æ¯”è¾ƒç¹çï¼Œè¿™é‡Œå°±ä¸å ç¯‡å¹…äº†ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯æ ¹æ®ä»»åŠ¡çš„ç±»å‹ï¼Œå‘èµ·å¼‚æ­¥è°ƒåº¦ä»»åŠ¡ï¼Œåœ¨è°ƒåº¦ç« èŠ‚å·²ç»è®²äº†è°ƒåº¦æµç¨‹ã€‚æ¥ä¸‹æ¥ä¼šèµ°è°ƒåº¦çš„æµç¨‹ã€‚</p><ul><li>å¯¹äº <code>legacy sync</code> æ¨¡å¼æœ€åçš„æ›´æ–°ä»»åŠ¡æ˜¯ <code>performSyncWorkOnRoot</code> ã€‚</li><li>å¯¹äº <code>Concurrent</code> æ¨¡å¼æœ€åçš„æ›´æ–°ä»»åŠ¡æ˜¯ <code>performConcurrentWorkOnRoot</code>ã€‚</li></ul><p>æˆ‘ä»¬ä»Šå¤©ä¸»è¦è®²çš„æ˜¯ç»„ä»¶ beginWork æ›´æ–°æµç¨‹ï¼Œæ‰€ä»¥è¿™é‡Œä¸»è¦ä»¥ legacy æ¨¡å¼ä¸ºä¸»ï¼Œæ‰€ä»¥è·Ÿç€ performSyncWorkOnRoot æµç¨‹å¾€ä¸‹çœ‹ï¼š</p><blockquote><p>react-reconciler/src/ReactFiberWorkLoop.new.js -&gt; performSyncWorkOnRoot</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> performSyncWorkOnRoot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">root</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* render é˜¶æ®µ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> exitStatus </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> renderRootSync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(root, lanes);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* commit é˜¶æ®µ */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    commitRoot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(root);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* å¦‚æœæœ‰å…¶ä»–çš„ç­‰å¾…ä¸­çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆç»§ç»­æ›´æ–° */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ensureRootIsScheduled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(root, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>ä¹‹å‰çš„ç« èŠ‚ä¸­ä»‹ç»äº†è°ƒå’Œçš„ä¸¤å¤§é˜¶æ®µ <code>render</code> å’Œ <code>commit</code> éƒ½åœ¨è¿™ä¸ªå‡½æ•°ä¸­æ‰§è¡Œã€‚</p><ul><li><code>renderRootSync</code> ä»£è¡¨ render é˜¶æ®µã€‚</li><li><code>commitRoot</code> ä»£è¡¨ commit é˜¶æ®µã€‚</li><li>å½“ render å’Œ commit é˜¶æ®µæ‰§è¡Œä¹‹åï¼Œå¦‚æœæœ‰å…¶ä»–çš„ç­‰å¾…ä¸­çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆç»§ç»­æ‰§è¡Œè°ƒåº¦ä»»åŠ¡ã€‚</li></ul><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œä¸€æ¬¡æ›´æ–°è°ƒåº¦ä»»åŠ¡çš„åˆå§‹åŒ–å·¥ä½œå®Œæˆã€‚å¼€å§‹æ­£å¼è¿›å…¥è°ƒå’Œé˜¶æ®µã€‚æˆ‘å¯¹å‰æˆé˜¶æ®µåšä¸€ä¸‹æ€»ç»“ï¼Œæµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c8710f7ad77f44ecb97cd6200c4a5b76~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="2.jpg" loading="lazy"></p><h3 id="å››-æ¢ç´¢-ä»-workloop-åˆ°-beginwork" tabindex="-1">å›› æ¢ç´¢ï¼šä» workLoop åˆ° beginWork â€‹</h3><p>ä¸Šè¿°è®²åˆ°äº† performSyncWorkOnRoot æ­£å¼è¿›å…¥äº† fiber çš„è°ƒå’Œæµç¨‹ã€‚å› ä¸ºæœ¬ç« èŠ‚ä¸»è¦è®² beginWork å’Œç»„ä»¶æ›´æ–°æµç¨‹ï¼Œè¿™äº›ä¸»è¦éƒ½å‘ç”Ÿåœ¨ <code>render</code> é˜¶æ®µï¼Œæ‰€ä»¥ä¸‹é¢å°†å›´ç»• <code>renderRootSync</code> å±•å¼€ã€‚é¦–å…ˆçœ‹ä¸€ä¸‹ renderRootSync åšäº†ä»€ä¹ˆï¼Ÿ</p><blockquote><p>react-reconciler/src/ReactFiberWorkLoop.new.js -&gt; renderRootSync</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> renderRootSync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">root</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">lanes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">){</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    workLoopSync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* workLoopå®Œæ¯•åï¼Œè¯æ˜æ‰€æœ‰èŠ‚ç‚¹éƒ½éå†å®Œæ¯•ï¼Œé‚£ä¹ˆé‡ç½®çŠ¶æ€ï¼Œè¿›å…¥ commit é˜¶æ®µ */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    workInProgressRoot </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    workInProgressRootRenderLanes </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> NoLanes;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>renderRootSync æ ¸å¿ƒåŠŸèƒ½ï¼š</p><ul><li>æ‰§è¡Œ <code>workLoopSync</code>ã€‚</li><li><code>workLoop</code> å®Œæ¯•åï¼Œè¯æ˜æ‰€æœ‰èŠ‚ç‚¹éƒ½éå†å®Œæ¯•ï¼Œé‚£ä¹ˆé‡ç½®çŠ¶æ€ï¼Œè¿›å…¥ <code>commit</code> é˜¶æ®µã€‚</li></ul><p><code>workLoopSync</code> åœ¨æ•´ä¸ª render æµç¨‹ä¸­å……å½“çš„è§’è‰²éå¸¸é‡è¦ï¼Œå¯ä»¥æŠŠ <code>workLoopSync</code> å½“ä½œä¸€ä¸ªå¾ªç¯è¿ä½œçš„åŠ å·¥å™¨ï¼Œæ¯ä¸€ä¸ªéœ€è¦è°ƒå’Œçš„ fiber å¯ä»¥å½“ä½œä¸€ä¸ªé›¶ä»¶ï¼Œæ¯ä¸€ä¸ªé›¶ä»¶éƒ½éœ€è¦è¿›å…¥åŠ å·¥å™¨ï¼Œå¦‚æœæ²¡æœ‰å¾…åŠ å·¥çš„é›¶ä»¶ï¼Œé‚£ä¹ˆåŠ å·¥å™¨æ‰åœæ­¢è¿è½¬ã€‚ä¸‹é¢å°±æ˜¯åŠ å·¥å™¨çš„å…·ä½“å®ç°ã€‚</p><blockquote><p>react-reconciler/src/ReactFiberWorkLoop.new.js -&gt; workLoopSync</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> workLoopSync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* å¾ªç¯æ‰§è¡Œ performUnitOfWork ï¼Œä¸€ç›´åˆ° workInProgress ä¸ºç©º */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (workInProgress </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    performUnitOfWork</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(workInProgress);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li>å¦‚ä¸Šåªè¦ <code>workInProgress</code> ä¸ä¸º <code>null</code>ï¼ˆè¿˜æœ‰éœ€è¦è°ƒå’Œçš„ fiberï¼‰ï¼Œé‚£ä¹ˆ workLoopSync ä¼šå¾ªç¯è°ƒç”¨ performUnitOfWorkã€‚</li></ul><p>åœ¨è°ƒåº¦ç« èŠ‚è®²åˆ°è¿‡ï¼Œå½“ Concurrent æ¨¡å¼ä¸‹ä¼šé€šè¿‡ <code>shouldYield</code> ï¼Œæ¥åˆ¤æ–­æœ‰æ²¡æœ‰è¿‡æœŸçš„ä»»åŠ¡ï¼Œæœ‰è¿‡æœŸä»»åŠ¡ï¼Œä¼šä¸­æ–­ workLoop ï¼Œé‚£ä¹ˆä¹Ÿå°±æ˜¯è¯´æ˜äº†<strong>renderé˜¶æ®µæ˜¯å¯ä»¥è¢«æ‰“æ–­çš„</strong>ã€‚</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (workInProgress </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">shouldYield</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  performUnitOfWork</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(workInProgress);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>å›åˆ° workLoopSync æµç¨‹ä¸Šæ¥ï¼Œé€šè¿‡ fiber ç« èŠ‚ï¼Œè®²åˆ° fiber æ ‘æ˜¯æ·±åº¦ä¼˜å…ˆéå†å¾—åˆ°çš„ï¼Œåœ¨éå†å®Œçˆ¶èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±ä¼šéå†å­èŠ‚ç‚¹ã€‚åœ¨è¿™å…¶ä¸­ï¼Œæ¯ä¸€ä¸ªè°ƒå’Œçš„ fiber éƒ½å°†ä½œä¸º <code>workInProgress</code> è¿›è¡Œè°ƒå’Œæ›´æ–°ã€‚</p><p>æ— è®ºä»€ä¹ˆæ¨¡å¼ï¼ŒworkLoop çš„æ‰§è¡Œå•å…ƒéƒ½æ˜¯ fiber ã€‚è€Œä¸”æ›´æ–°å•å…ƒçš„å‡½æ•°å«åš performUnitOfWork ã€‚</p><blockquote><p>react-reconciler/src/ReactFiberWorkLoop.new.js -&gt; performUnitOfWork</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> performUnitOfWork</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">unitOfWork</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> current</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> unitOfWork.alternate;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  next </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> beginWork</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(current, unitOfWork, subtreeRenderLanes);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    unitOfWork.memoizedProps </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> unitOfWork.pendingProps;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (next </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">       completeUnitOfWork</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(unitOfWork);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      workInProgress </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> next;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>åœ¨ fiber ç« èŠ‚è®²åˆ°è¿‡, beginWork æ˜¯å‘ä¸‹è°ƒå’Œæµç¨‹ï¼ŒcompleteUnitOfWork æ˜¯å‘ä¸Šå½’å¹¶çš„æµç¨‹ã€‚é‚£ä¹ˆä»¥ç»„ä»¶æ›´æ–°æµç¨‹ä¸ºç›®çš„ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥é‡ç‚¹ç ”ç©¶ beginWork æµç¨‹ã€‚</p><p>åœ¨ä»‹ç» beginWork ä¹‹å‰å…ˆæ¥çœ‹å‡ ä¸ªåœºæ™¯ï¼š</p><p>å‡è®¾æœ‰ä¸€ä¸ªç»„ä»¶ fiber é“¾ã€‚æˆ‘ä»¬åœ¨è¿™ä¸ª fiber é“¾ä¸Šæš‚ä¸”æ— è§†å…¶ä»–ç±»å‹çš„ fiberï¼Œåªä¿ç•™ç»„ä»¶ç±»å‹çš„ fiberã€‚ç»“æ„å¦‚ä¸‹ï¼š</p><p>root Fiber --child--&gt; Aç»„ä»¶ --child--&gt; Bç»„ä»¶ --child--&gt; Cç»„ä»¶ã€‚</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/46a8441e883f4d70a39e5e56b58d6ff9~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="4.jpg" loading="lazy"></p><p>è€Œä¸»è§’å°±æ˜¯<strong>ç»„ä»¶B</strong>ï¼Œä»¥ç»„ä»¶B ä¸ºå‚è€ƒã€‚æ¥çœ‹ä¸€ä¸‹ React å¦‚ä½•è°ƒå’Œçš„ã€‚é‚£ä¹ˆä¸€æ¬¡æ›´æ–°å°±æœ‰å¯èƒ½æœ‰ä¸‰ç§åœºæ™¯ï¼š</p><ul><li>åœºæ™¯ä¸€ï¼š<strong>æ›´æ–° A ç»„ä»¶ state</strong>ï¼Œé‚£ä¹ˆ A è§¦å‘æ›´æ–°ï¼Œé‚£ä¹ˆå¦‚æœ B,C æ²¡æœ‰åšæ¸²æŸ“æ§åˆ¶å¤„ç†ï¼ˆæ¯”å¦‚ memo PureComponentï¼‰ï¼Œé‚£ä¹ˆæ›´æ–°ä¼šæ³¢åŠ¨åˆ° B ï¼Œ Cï¼Œé‚£ä¹ˆ Aï¼ŒBï¼ŒC éƒ½ä¼š rerenderã€‚</li></ul><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/37a14aa23434495aba1b9dfb985ff219~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="5.jpg" loading="lazy"></p><ul><li>åœºæ™¯äºŒï¼š<strong>å½“æ›´æ–° B ç»„ä»¶</strong>ï¼Œé‚£ä¹ˆç»„ä»¶ A fiber ä¼šè¢«æ ‡è®°ï¼Œç„¶å A ä¼šè°ƒå’Œï¼Œä½†æ˜¯ä¸ä¼š rerenderï¼›ç»„ä»¶ B æ˜¯å½“äº‹äººï¼Œæ—¢ä¼šè¿›å…¥è°ƒå’Œï¼Œä¹Ÿä¼š rerenderï¼›ç»„ä»¶ C å—åˆ°çˆ¶ç»„ä»¶ B çš„å½±å“ï¼Œä¼š rerenderã€‚</li></ul><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e21e929037b04614897e20338752f324~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="6.jpg" loading="lazy"></p><ul><li>åœºæ™¯ä¸‰ï¼š<strong>å½“æ›´æ–° Cç»„ä»¶</strong>ï¼Œé‚£ä¹ˆ Aï¼ŒB ä¼šè¿›å…¥è°ƒå’Œæµç¨‹ï¼Œä½†æ˜¯ä¸ä¼š rerenderï¼ŒC æ˜¯å½“äº‹äººï¼Œä¼šè°ƒå’Œå¹¶ rerenderã€‚</li></ul><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3691b87d164a427b8c7a180e53b6d84d~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="7.jpg" loading="lazy"></p><p>é‚£ä¹ˆå¦‚ä¸Šçš„åœºæ™¯æœ¬è´¨ä¸Šéƒ½åœ¨ <code>beginWork</code> ä¸­è¿›è¡Œçš„ï¼Œè¿™ä¸ª beginWork æ˜¯å¦‚ä½•å¤„ç†è¿™äº›é€»è¾‘çš„ã€‚</p><h3 id="äº”-æ­ç§˜-ä»-beginwork-åˆ°ç»„ä»¶æ›´æ–°å…¨æµç¨‹" tabindex="-1">äº” æ­ç§˜ï¼šä» beginWork åˆ°ç»„ä»¶æ›´æ–°å…¨æµç¨‹ â€‹</h3><p>æ¥ä¸‹æ¥ä» beginWork å¼€å§‹ï¼Œé‡ç‚¹ç ”ç©¶ä¸€ä¸‹æµç¨‹ã€‚</p><h4 id="_1-beginwork-æ›´æ–°çš„è°ƒåº¦ç«™" tabindex="-1">1 beginWork æ›´æ–°çš„è°ƒåº¦ç«™ â€‹</h4><blockquote><p>react-reconciler/src/ReactFiberBeginWork.new.js -&gt; beginWork</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> {*}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> current</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         current æ ‘ fiber </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> {*}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> workInProgress</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  workInProgress æ ‘ fiber </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> {*}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> renderLanes</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     å½“å‰çš„ render ä¼˜å…ˆçº§</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@returns</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> beginWork</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">current</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">workInProgress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">renderLanes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">){</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* -------------------ç¬¬ä¸€éƒ¨åˆ†-------------------- */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(current </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">){ </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* æ›´æ–°æµç¨‹ */</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* current æ ‘ä¸Šä¸Šä¸€æ¬¡æ¸²æŸ“åçš„ props */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> oldProps</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> current.memoizedProps;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* workInProgress æ ‘ä¸Šè¿™ä¸€æ¬¡æ›´æ–°çš„ props  */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> newProps</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> workInProgress.pendingProps;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(oldProps </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> newProps </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  hasLegacyContextChanged</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()){</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          didReceiveUpdate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          /* props å’Œ context æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œæ£€æŸ¥æ˜¯å¦æ›´æ–°æ¥è‡ªè‡ªèº«æˆ–è€… context æ”¹å˜ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> hasScheduledUpdateOrContext</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> checkScheduledUpdateOrContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(current,renderLanes)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">hasScheduledUpdateOrContext){</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">              didReceiveUpdate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">              return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  attemptEarlyBailoutIfNoScheduledUpdate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(current,workInProgress,renderLanes)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          /* è¿™é‡Œçœç•¥äº†ä¸€äº›åˆ¤æ–­é€»è¾‘ */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          didReceiveUpdate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      didReceiveUpdate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* -------------------ç¬¬äºŒéƒ¨åˆ†-------------------- */</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* TODO: èµ°åˆ°è¿™é‡Œæµç¨‹ä¼šè¢«è°ƒå’Œ | æ›´æ–°ï¼Œæ¯”å¦‚å‡½æ•°æ‰§è¡Œä¼šæ‰§è¡Œï¼Œç±»ç»„ä»¶ä¼šæ‰§è¡Œ render ã€‚ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    switch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(workInProgress.tag){</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* å‡½æ•°ç»„ä»¶çš„æƒ…å†µ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FunctionComponent: {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">           return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> updateFunctionComponent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">( current, workInProgress, Component, resolvedProps, renderLanes )</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* ç±»ç»„ä»¶çš„æƒ…å†µ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ClassComponent:{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> updateClassComponent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(current,workInProgress,Component,resolvedProps,renderLanes)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* å…ƒç´ ç±»å‹ fiber &lt;div&gt;, &lt;span&gt;  */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> HostComponent:{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> updateHostComponent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(current, workInProgress, renderLanes)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* å…¶ä»– fiber æƒ…å†µ */</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>å¦‚ä¸Šå°±æ˜¯ <code>beginWork</code> çš„å…¨æµç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•´ä¸ªæµç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µã€‚</p><h4 id="_2-ç¬¬ä¸€é˜¶æ®µ" tabindex="-1">2 ç¬¬ä¸€é˜¶æ®µ â€‹</h4><p>ç¬¬ä¸€éƒ¨åˆ†ï¼Œè¿™éƒ¨åˆ†éå¸¸é‡è¦å°±æ˜¯åˆ¤æ–­æ›´æ–°æƒ…å†µçš„ï¼Œä¸Šé¢çš„ä¸‰ç§åœºæ™¯éƒ½å¯ä»¥åœ¨ç¬¬ä¸€é˜¶æ®µè¿›è¡Œåˆ¤æ–­å¤„ç†ã€‚å…ˆæ¥åˆ†æä¸€ä¸‹ç¬¬ä¸€é˜¶æ®µåšäº†å“ªäº›äº‹ã€‚æ­£å¼è®²è§£ä¹‹å‰å…ˆæ¥çœ‹ä¸€ä¸ªå˜é‡çš„æ„ä¹‰ï¼Œé‚£å°±æ˜¯ <code>didReceiveUpdate</code> ã€‚</p><ul><li><p>didReceiveUpdate ï¼šè¿™ä¸ªå˜é‡ä¸»è¦è¯æ˜å½“å‰æ›´æ–°æ˜¯å¦æ¥æºäºçˆ¶çº§çš„æ›´æ–°ï¼Œé‚£ä¹ˆè‡ªèº«å¹¶æ²¡æœ‰æ›´æ–°ã€‚æ¯”å¦‚æ›´æ–° B ç»„ä»¶ï¼Œé‚£ä¹ˆ Cç»„ä»¶ä¹Ÿä¼šè·Ÿç€æ›´æ–°ï¼Œè¿™ä¸ªæƒ…å†µä¸‹ <code>didReceiveUpdate = true</code>ã€‚</p></li><li><p>é¦–å…ˆé€šè¿‡ <code>current!== null</code> æ¥åˆ¤æ–­å½“å‰ fiber æ˜¯å¦åˆ›å»ºè¿‡ï¼Œå¦‚æœç¬¬ä¸€æ¬¡ mounted ï¼Œ é‚£ä¹ˆ current ä¸º nullï¼Œè€Œç¬¬ä¸€é˜¶æ®µä¸»è¦é’ˆå¯¹æ›´æ–°çš„æƒ…å†µã€‚å¦‚æœåˆå§‹åŒ–ï¼Œé‚£ä¹ˆç›´æ¥è·³è¿‡ç¬¬ä¸€é˜¶æ®µï¼Œ<strong>åˆ°ç¬¬äºŒé˜¶æ®µ</strong>ã€‚</p></li><li><p>å¦‚æœæ˜¯æ›´æ–°æµç¨‹ã€‚é‚£ä¹ˆåˆ¤æ–­ oldProps === newPropsï¼ˆæºç ä¸­è¿˜åˆ¤æ–­äº†è€ç‰ˆæœ¬ context æ˜¯å¦å˜åŒ–ï¼‰ï¼Œé‚£ä¹ˆä¸¤è€…ç›¸ç­‰ã€‚ä¸€èˆ¬ä¼šæœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š</p></li></ul><p><strong>æƒ…å†µä¸€</strong>ï¼šè¿˜æ˜¯å›åˆ°ä¸Šé¢åœºæ™¯ä¸Šæ¥ï¼Œå¦‚æœ C ç»„ä»¶æ›´æ–°ï¼Œé‚£ä¹ˆ B ç»„ä»¶è¢«æ ‡è®° ChildLanes ä¼šè¿›å…¥åˆ° beginWork è°ƒå’Œé˜¶æ®µï¼Œä½†æ˜¯ B ç»„ä»¶æœ¬èº« props ä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚</p><p><strong>æƒ…å†µäºŒ</strong>ï¼šé€šè¿‡ useMemo ç­‰æ–¹å¼ç¼“å­˜äº† React element å…ƒç´ ï¼Œåœ¨æ¸²æŸ“æ§åˆ¶ç« èŠ‚è®²åˆ°è¿‡ã€‚</p><p><strong>æƒ…å†µä¸‰</strong>ï¼šå°±æ˜¯æ›´æ–°å‘ç”Ÿåœ¨å½“å‰ç»„ä»¶æœ¬èº«ï¼Œæ¯”å¦‚ B ç»„ä»¶å‘ç”Ÿæ›´æ–°ï¼Œä½†æ˜¯ B ç»„ä»¶çš„ props å¹¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥ä¹Ÿä¼šèµ°åˆ°è¿™ä¸ªæµç¨‹ä¸Šæ¥ã€‚</p><p>åä¹‹å¦‚æœä¸¤è€…ä¸æƒ³ç­‰ï¼Œè¯æ˜çˆ¶çº§ fiber é‡æ–° rerender å¯¼è‡´äº† props æ”¹å˜ï¼Œæ­¤æ—¶ didReceiveUpdate = true ï¼Œé‚£ä¹ˆç¬¬ä¸€é˜¶æ®µå®Œæˆï¼Œ<strong>è¿›å…¥åˆ°ç¬¬äºŒé˜¶æ®µ</strong>ã€‚</p><p>åˆšæ‰è®²åˆ°å¦‚æœ<strong>æ–°è€ props ç›¸ç­‰</strong>ï¼Œä¼šæœ‰ä¸€äº›å¤„ç†é€»è¾‘ã€‚é‚£ä¹ˆå¦‚æœå¤„ç†çš„å‘¢ï¼Ÿç¬¬ä¸€ä¸ªå°±æ˜¯è°ƒç”¨ <code>checkScheduledUpdateOrContext</code></p><p><strong>checkScheduledUpdateOrContext</strong></p><blockquote><p>react-reconciler/src/ReactFiberBeginWork.new.js -&gt; checkScheduledUpdateOrContext</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> checkScheduledUpdateOrContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">current</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">renderLanes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> updateLanes</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> current.lanes;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* è¿™ç§æƒ…å†µè¯´æ˜å½“å‰æ›´æ–° */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">includesSomeLane</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(updateLanes, renderLanes)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     /* å¦‚æœè¯¥ fiber æ¶ˆè´¹äº† context ï¼Œå¹¶ä¸” context å‘ç”Ÿäº†æ”¹å˜ã€‚ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (enableLazyContextPropagation) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> dependencies</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> current.dependencies;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (dependencies </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> checkIfContextChanged</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dependencies)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li>å½“æ–°è€ props ç›¸ç­‰æƒ…å†µï¼Œé¦–å…ˆä¼šæ£€æŸ¥å½“å‰ fiber çš„ <code>lane</code> æ˜¯å¦ç­‰äºå½“å‰çš„æ›´æ–°ä¼˜å…ˆçº§ï¼Œå¦‚æœç›¸ç­‰ï¼Œé‚£ä¹ˆè¯æ˜æ›´æ–°æ¥æºå½“å‰ fiberï¼Œæ¯”å¦‚ B ç»„ä»¶å‘ç”Ÿæ›´æ–°ï¼Œé‚£ä¹ˆä¼šèµ°è¿™é‡Œï¼ˆæƒ…å†µä¸‰ï¼‰ã€‚å½“ç„¶æœŸé—´ä¹Ÿä¼šåˆ¤æ–­æ˜¯å¦æœ‰æ¶ˆè´¹ <code>context</code> å¹¶å‘ç”Ÿäº†å˜åŒ–ã€‚æœ€åè¿”å›çŠ¶æ€ hasScheduledUpdateOrContext ã€‚</li></ul><p>å¦‚æœ <code>hasScheduledUpdateOrContext</code> ä¸º falseï¼Œè¯æ˜å½“å‰ç»„ä»¶æ²¡æœ‰æ›´æ–°ï¼Œä¹Ÿæ²¡æœ‰ context ä¸Šçš„å˜åŒ–ï¼Œé‚£ä¹ˆè¿˜æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯ child å¯èƒ½æœ‰æ›´æ–°ï¼Œä½†æ˜¯å½“å‰ fiber ä¸éœ€è¦æ›´æ–°ï¼ˆæƒ…å†µä¸€ï¼‰ã€‚é‚£ä¹ˆä¼šç›´æ¥è¿”å› <code>attemptEarlyBailoutIfNoScheduledUpdate</code> ï¼Œ<strong>é€€å‡ºç¬¬äºŒé˜¶æ®µ</strong>ã€‚</p><p>attemptEarlyBailoutIfNoScheduledUpdate è¿™ä¸ªå‡½æ•°ä¼šå¤„ç†éƒ¨åˆ† Context é€»è¾‘ï¼Œä½†æ˜¯æœ€é‡è¦çš„æ˜¯è°ƒç”¨äº† <code>bailoutOnAlreadyFinishedWork</code> ã€‚</p><blockquote><p>react-reconciler/src/ReactFiberBeginWork.new.js -&gt; bailoutOnAlreadyFinishedWork</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bailoutOnAlreadyFinishedWork</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">current</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">workInProgress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">renderLanes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">){</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     /* å¦‚æœ children æ²¡æœ‰é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œè¯´æ˜æ‰€æœ‰çš„ child éƒ½æ²¡æœ‰æ›´æ–°ï¼Œé‚£ä¹ˆç›´æ¥ è¿”å›ï¼Œchild ä¹Ÿä¸ä¼šè¢«è°ƒå’Œ  */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">includesSomeLane</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(renderLanes, workInProgress.childLanes)) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      /* è¿™é‡Œåšäº†æµç¨‹ç®€åŒ– */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* å½“å‰fiberæ²¡æœ‰æ›´æ–°ã€‚ä½†æ˜¯å®ƒçš„children éœ€è¦æ›´æ–°ã€‚  */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    cloneChildFibers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(current, workInProgress);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> workInProgress.child;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>bailoutOnAlreadyFinishedWork æµç¨‹éå¸¸é‡è¦ã€‚å®ƒä¸»è¦åšäº†ä¸¤ä»¶äº‹ã€‚</p><ul><li><p>é¦–å…ˆé€šè¿‡ includesSomeLane åˆ¤æ–­ childLanes æ˜¯å¦æ˜¯é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œå¦‚æœä¸æ˜¯ï¼Œé‚£ä¹ˆæ‰€æœ‰å­å­™ fiber éƒ½ä¸éœ€è¦è°ƒå’Œ ï¼Œé‚£ä¹ˆç›´æ¥è¿”å› nullï¼Œchild ä¹Ÿä¸ä¼šè¢«è°ƒå’Œã€‚</p></li><li><p>å¦‚æœ childLanes ä¼˜å…ˆçº§é«˜ï¼Œé‚£ä¹ˆè¯æ˜ child éœ€è¦è¢«è°ƒå’Œï¼Œä½†æ˜¯å½“å‰ç»„ä»¶ä¸éœ€è¦ï¼Œæ‰€ä»¥ä¼šå…‹éš†ä¸€ä¸‹ childrenï¼Œè¿”å› children ï¼Œé‚£ä¹ˆæœ¬èº«ä¸ä¼š <code>rerender</code>ã€‚</p></li></ul><p>åˆ°è¿™é‡Œç¬¬ä¸€é˜¶æ®µå®Œæˆäº†ï¼Œå®Œæˆäº†ç»„ä»¶æ›´æ–°æµç¨‹çš„æ‰€æœ‰æƒ…å†µã€‚ç¬¬ä¸€é˜¶æ®µå®Œæˆä¼šè¿›å…¥åˆ°æ›´æ–°çš„ç¬¬äºŒé˜¶æ®µã€‚</p><h4 id="_3-ç¬¬äºŒé˜¶æ®µ" tabindex="-1">3 ç¬¬äºŒé˜¶æ®µ â€‹</h4><p>ä» beginWork çš„æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œç¬¬äºŒé˜¶æ®µå°±æ˜¯æ›´æ–° fiberï¼Œæ¯”å¦‚æ˜¯å‡½æ•°ç»„ä»¶ï¼Œå°±ä¼šè°ƒç”¨ <code>updateFunctionComponent</code>ï¼Œç±»ç»„ä»¶å°±è°ƒç”¨ <code>updateClassComponent</code>ï¼Œç„¶åè¿›è¡Œ rerender äº†ã€‚</p><h4 id="_4-æµç¨‹æ€»ç»“" tabindex="-1">4 æµç¨‹æ€»ç»“ â€‹</h4><p>æ¥ä¸‹æ¥ä»¥ä¸Šè¿°ä¸­çš„<strong>ç»„ä»¶B</strong>ä¸ºä¾‹å­ï¼Œåœ¨å¼ºåŒ–ä¸€ä¸‹æ›´æ–°æµç¨‹ã€‚</p><p><strong>åœºæ™¯ä¸€</strong>ï¼šå½“æ›´æ–° A æ—¶å€™ï¼Œé‚£ä¹ˆ A ç»„ä»¶çš„ fiber ä¼šè¿›å…¥è°ƒå’Œæµç¨‹ï¼Œä¼šæ‰§è¡Œ render å½¢æˆæ–°çš„ç»„ä»¶ B å¯¹åº”çš„ element å…ƒç´ ï¼Œæ¥ä¸‹æ¥è°ƒå’Œ B ï¼Œå› ä¸º B çš„ newProps ä¸ç­‰äº oldPropsï¼Œæ‰€ä»¥ä¼š didReceiveUpdate = true ï¼Œç„¶åæ›´æ–°ç»„ä»¶ï¼Œä¹Ÿä¼šè§¦å‘ renderã€‚ï¼ˆè¿™é‡Œéƒ½æ˜¯é»˜è®¤æ²¡æœ‰æ¸²æŸ“æ§åˆ¶çš„åœºæ™¯ï¼Œæ¯”å¦‚ memo PureComponent ç­‰ ï¼‰ï¼Œè¿™æ ·ä¹Ÿå°±è§£å†³äº†æ–‡ç« å¼€å¤´çš„é—®é¢˜å››ã€‚</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d8a6957eadb24a92992c33aae021815c~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="8.jpg" loading="lazy"></p><p><strong>åœºæ™¯äºŒ</strong>ï¼šå½“æ›´æ–° B æ—¶å€™ï¼Œé‚£ä¹ˆ A ç»„ä»¶ä¼šæ ‡è®° childLanesï¼Œæ‰€ä»¥ A ä¼šè¢«è°ƒå’Œï¼Œä½†æ˜¯ä¸ä¼š renderï¼Œç„¶ååˆ°äº†ä¸»è§’ B ï¼ŒB ç”±äºæ–°è€ props ç›¸ç­‰ï¼Œæ‰€ä»¥ä¼š <code>checkScheduledUpdateOrContext</code> æµç¨‹ï¼Œåˆ¤æ–­ lane ç­‰äº renderLanes ï¼Œæ£€æŸ¥åˆ° lane ç­‰äº renderLaneï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œæ›´æ–°ï¼Œè§¦å‘ renderã€‚ C ç»„ä»¶ä¹Ÿå°±è·Ÿç€æ›´æ–°ã€‚</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9d8b4c1d668d47778b52e3c2c5bc843f~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="9.jpg" loading="lazy"></p><p><strong>åœºæ™¯ä¸‰</strong>ï¼šå½“æ›´æ–° C æ—¶å€™ï¼Œé‚£ä¹ˆ A å’Œ B ç»„ä»¶ä¼šæ ‡è®° childLanesï¼Œæ‰€ä»¥ A å’Œ B ä¼šè¢«è°ƒå’Œï¼Œä½†æ˜¯ä¸ä¼šæ›´æ–°ï¼Œç„¶ååˆ° C ï¼ŒC ä¼šèµ°æ­£å¸¸æµç¨‹ã€‚</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8d1bfffd917d4e458c6544ee9aa1ff55~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="10.jpg" loading="lazy"></p><p><strong>åœºæ™¯å››</strong>ï¼šè¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œä»€ä¹ˆæ—¶å€™ B ä¼šè·³å‡ºè°ƒå’Œæµç¨‹å‘¢ã€‚</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eaf97e258da4462c8b5ddf85a284e2ca~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="11.jpg" loading="lazy"></p><p>åˆ°æ­¤ä¸ºæ­¢å®Œæˆäº†æ•´ä¸ªæ›´æ–°æµç¨‹ã€‚</p><h4 id="_5-beginwork-æµç¨‹å›¾" tabindex="-1">5 beginWork æµç¨‹å›¾ â€‹</h4><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/99afa68f8ab94c93be41df70db0ae488~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="3.jpg" loading="lazy"></p><h3 id="æ€»ç»“" tabindex="-1">æ€»ç»“ â€‹</h3><p>é€šè¿‡æœ¬ç« èŠ‚çš„å­¦ä¹ ï¼Œæˆ‘ä»¬åº”è¯¥æŒæ¡çš„çŸ¥è¯†ç‚¹å¦‚ä¸‹ï¼š</p><ul><li>ç»„ä»¶æ›´æ–°å’Œè°ƒå’Œè¿‡ç¨‹ã€‚rerender ä¸€å®šä¼šè°ƒå’Œï¼Œä½†æ˜¯è°ƒå’Œå¹¶ä¸ä¸€å®š rerenderï¼Œä¹Ÿæœ‰å¯èƒ½æ‰¾åˆ°å¾…æ›´æ–°çš„å­å…ƒç´ ã€‚</li><li>ç»„ä»¶ç±»å‹çš„æ›´æ–°çš„å‡ ç§æƒ…å†µã€‚</li><li>ä»å‡ºå‘æ›´æ–°åˆ° beginWork å…¨æµç¨‹ã€‚</li></ul>`,137),l=[p];function t(h,k,r,d,o,E){return a(),i("div",null,l)}const b=s(e,[["render",t]]);export{u as __pageData,b as default};
